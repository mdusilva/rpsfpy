<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>rpsfpy.rpsf API documentation</title>
    <meta name="description" content="Module with functions to compute estimation of PSFs (and/or OTFs). Includes functions to compute str..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.ao_systems">ao_systems</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.logger">logger</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.pclib">pclib</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.fftcorr">fftcorr</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.polar2">polar2</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.AOsystem">AOsystem</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.AOsystem.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.AOsystem.add">add</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.AOsystem.get">get</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.AOsystem.remove">remove</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.AOsystem.view">view</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.Atmosphere">Atmosphere</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.Atmosphere.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Atmosphere.readfromfile">readfromfile</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.Pclib">Pclib</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.Pclib.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Pclib.add">add</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Pclib.getfunction">getfunction</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Pclib.isknown">isknown</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Pclib.remove">remove</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.Reconstruct">Reconstruct</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.Reconstruct.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Reconstruct.otf">otf</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Reconstruct.otf_fromfiles">otf_fromfiles</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Reconstruct.psf">psf</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Reconstruct.strut_functions">strut_functions</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.Structure">Structure</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.Structure.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Structure.cart2polar">cart2polar</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Structure.compvii">compvii</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Structure.correl_swsw">correl_swsw</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.Structure.diagcoef">diagcoef</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.StructureFit">StructureFit</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.cart2polar">cart2polar</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.compute">compute</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.compvii">compvii</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.correl_swsw">correl_swsw</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.diagcoef">diagcoef</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.readfromfile">readfromfile</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureFit.save2file">save2file</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.StructureLGS">StructureLGS</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.cart2polar">cart2polar</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.compute">compute</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.compute_term">compute_term</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.compvii">compvii</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.correl_swsw">correl_swsw</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.cov_zernike">cov_zernike</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.diagcoef">diagcoef</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.readfromfile">readfromfile</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.save2file">save2file</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.setlgspos">setlgspos</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureLGS.setobjpos">setobjpos</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#rpsfpy.rpsf.StructureNGS">StructureNGS</a></span>
        
          
  <ul>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.__init__">__init__</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.cart2polar">cart2polar</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.compute">compute</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.compute_term">compute_term</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.compvii">compvii</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.correl_swsw">correl_swsw</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.cov_zernike">cov_zernike</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.diagcoef">diagcoef</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.readfromfile">readfromfile</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.save2file">save2file</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.setngspos">setngspos</a></li>
    <li class="mono"><a href="#rpsfpy.rpsf.StructureNGS.setobjpos">setobjpos</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">rpsfpy.rpsf</span> module</h1>
  <p>Module with functions to compute estimation of PSFs (and/or OTFs). Includes functions to compute structure functions.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf" class="source">
    <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module with functions to compute estimation of PSFs (and/or OTFs). Includes functions to compute structure functions.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span>
<span class="c1">#from scipy.special import jv</span>
<span class="c1">#from scipy.integrate import trapz, quad, romberg</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">zernike</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyfits</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="kn">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">chassat</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="c1">#from multiprocessing import Pool</span>
<span class="c1">#from multiprocessing import cpu_count</span>

<span class="kn">import</span> <span class="nn">copy_reg</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">MethodType</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The integral is probably divergent, or slowly convergent.&quot;</span><span class="p">)</span>
<span class="c1">#create logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;show the module activity in the terminal and store debug details in a log file - **debug.log**.&quot;&quot;&quot;</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

 <span class="c1"># create console handler and set level to info</span>
<span class="n">_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">_formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

<span class="c1"># create error file handler and set level to debug</span>
<span class="n">_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s2">&quot;debug.log&quot;</span><span class="p">),</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">_formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_pickle_method</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
      <span class="n">func_name</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_func</span><span class="o">.</span><span class="n">__name__</span>
      <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_self</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_class</span>
      <span class="k">if</span> <span class="n">func_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">func_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
	<span class="n">cls_name</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">cls_name</span><span class="p">:</span> <span class="n">func_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">cls_name</span> <span class="o">+</span> <span class="n">func_name</span>
      <span class="k">return</span> <span class="n">_unpickle_method</span><span class="p">,</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_unpickle_method</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
	<span class="k">try</span><span class="p">:</span>
	  <span class="n">func</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
	<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
	  <span class="k">pass</span>
	<span class="k">else</span><span class="p">:</span>
	  <span class="k">break</span>
      <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
<span class="n">copy_reg</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">MethodType</span><span class="p">,</span><span class="n">_pickle_method</span><span class="p">,</span> <span class="n">_unpickle_method</span><span class="p">)</span>

<span class="c1">#zernike coefficients correlation mask</span>
<span class="n">_maskfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s1">r&#39;masknn.fits&#39;</span><span class="p">)</span>
<span class="n">_z_handle</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_maskfile</span><span class="p">)</span>
<span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_z_handle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="k">def</span> <span class="nf">_compmask</span><span class="p">(</span><span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Zernike mask.&quot;&quot;&quot;</span>
    <span class="n">first</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">masku</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nz2</span><span class="p">):</span>
            <span class="n">masku</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">first</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">first</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">masku</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">z1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">z2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute K1 and K2 (cf. Chassat)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">m1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">z2</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="n">m2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">z1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">z2</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="n">m2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">elif</span> <span class="n">z2</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">K1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">m2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">K2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">z1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">z2</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K2</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">K2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">K2</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K2</span> <span class="o">=</span> <span class="mf">0.</span>                  
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">z2</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K2</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">K2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">K2</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span>

<span class="k">def</span> <span class="nf">_chassat_integral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Lam</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">K1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">K2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inner integral to compute the correlations (cf. Chassat, 1992)&quot;&quot;&quot;</span>
    <span class="c1">#compute bessel functions</span>
    <span class="n">j1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">n1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">w</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="n">j3</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">m1</span><span class="o">+</span><span class="n">m2</span><span class="p">,</span><span class="n">zeta</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="n">j4</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">),</span><span class="n">zeta</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">14.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1</span> <span class="o">*</span> <span class="n">j2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lam</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">11.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K1</span><span class="o">/</span><span class="n">w</span> <span class="o">*</span> <span class="n">j3</span> <span class="o">+</span> <span class="n">K2</span><span class="o">/</span><span class="n">w</span> <span class="o">*</span> <span class="n">j4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_modified_chassat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Lam</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">K1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">K2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change of variables to deal with improper integral.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_chassat_integral</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">Lam</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>

<span class="k">def</span> <span class="nf">fftcorr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute cross-correlation or autocorrelation using FFT.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X: numpy array</span>
<span class="sd">    </span>
<span class="sd">    Y: numpy array</span>

<span class="sd">    s: sequence of ints, optional</span>
<span class="sd">       shape of the output array, this passed to numpy&#39;s fft.fft2 function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    out: numpy array</span>
<span class="sd">         Correlation matrix of X and Y</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;shape&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">f1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">f2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Input must be two 2d arrays&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Input must be two 2d arrays&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">polar2</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">oc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fourpixels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">leq</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Compute pupil mask and polar coordinates.</span>

<span class="sd">    Assumes a circular pupil with some radius given in pixels and computes</span>
<span class="sd">    arrays containing grids of polar coordinates rho and phi and an array</span>
<span class="sd">    containing the pupil mask (i.e. 1 inside the pupil and 0 outside).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius: int or float  </span>
<span class="sd">        radius of pupil in pixels  </span>
<span class="sd">    oc: float, optional  </span>
<span class="sd">        size of central occultation for pupil mask (default=0.)  </span>
<span class="sd">    fourpixels: bool  </span>
<span class="sd">        if True and length is &lt; 0 or missing then the centre of the pupil is</span>
<span class="sd">        in the intersection of the four central pixels and the length set to</span>
<span class="sd">        an even number, if False the centre is in central pixel and length set to</span>
<span class="sd">        an odd number (of pixels)  </span>
<span class="sd">    leq: bool  </span>
<span class="sd">        if True the border of mask is included (points &lt;= radius), if False it</span>
<span class="sd">        is not (points &lt; radius)  </span>
<span class="sd">    length: float, optional  </span>
<span class="sd">        length of pupil in physical units, computed according to fourpixels argument</span>
<span class="sd">        if not given  </span>
<span class="sd">    center: array_like, optional  </span>
<span class="sd">        coordinates of pupil center, set to half of length if not given  </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    rho: ndarray  </span>
<span class="sd">        Array of rho coordinates  </span>
<span class="sd">    phi: ndarray  </span>
<span class="sd">        Array of phi coordinates  </span>
<span class="sd">    mask: ndarray  </span>
<span class="sd">        Array of pupil&#39;s mask (i.e. 1 inside the pupil and 0 outside)  </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fourpixels</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cy</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">cx</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="n">radius</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">rho</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leq</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">mask</span>

<span class="k">def</span> <span class="nf">_angletiti</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute angle for a point x,y and convert to 0-360 degree range.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">360.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">360.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">270.</span> 
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">90.</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">180.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-6</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-6</span><span class="p">):</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">gamma</span> 


<span class="k">class</span> <span class="nc">Structure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muse GLAO structure functions</span>
<span class="sd">    Includes the effects of anisoplanetism and fitting errors only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Structure function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        aoname: string  </span>
<span class="sd">            name of the AO correction system  </span>
<span class="sd">        atmosphere: object  </span>
<span class="sd">            Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">        pixdiam: int  </span>
<span class="sd">            Diameter of the telescope pupil in pixels.  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        debug: bool  </span>
<span class="sd">            If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span> <span class="o">=</span> <span class="n">aoname</span>
        <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="n">_lgspos</span><span class="p">,</span> <span class="n">_hlgs</span><span class="p">,</span> <span class="n">_n_zernike</span><span class="p">,</span> <span class="n">_pupil_diameter</span> <span class="o">=</span> <span class="n">ao_systems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">_lgspos</span>
        <span class="sd">&quot;&quot;&quot;List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span> <span class="o">=</span> <span class="n">_hlgs</span>
        <span class="sd">&quot;&quot;&quot;Height of the LGSs (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">=</span> <span class="n">_n_zernike</span>
        <span class="sd">&quot;&quot;&quot;Number of Zernike modes corrected by the AO system. Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">=</span> <span class="n">_pupil_diameter</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the telescope mirror (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">cn2_profile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Normalized Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of atmospheric layers&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">atmosphere</span><span class="o">.</span><span class="n">outer_scale</span>
        <span class="sd">&quot;&quot;&quot;Value of the outer scale (in m). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">Zernike</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Zernike polynomial instance&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>  <span class="c1">#must be integer</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
        <span class="n">_rho</span><span class="p">,</span> <span class="n">_phi</span><span class="p">,</span> <span class="n">_mask</span> <span class="o">=</span> <span class="n">polar2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">fourpixels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">_rho</span>
        <span class="sd">&quot;&quot;&quot;Grid of rho polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">_phi</span>
        <span class="sd">&quot;&quot;&quot;Grid of phi polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">_mask</span>
        <span class="sd">&quot;&quot;&quot;Pupil function. Value is one inside the pupil and zero outside.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">&gt;</span> <span class="mi">980</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_compmask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_zcoef_mask</span>

    <span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert cartesian coordinates to polar for the object</span>
<span class="sd">        and the GSs absolute and relative positions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
        <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
        <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
        <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
        <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
            <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>

    <span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
        <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
        <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
        <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
                <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
        <span class="k">return</span> <span class="n">final_integral</span>

    <span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
        <span class="c1">#with svd</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#with eigen vectors</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>

    <span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
            <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
        <span class="k">return</span> <span class="n">u</span>


<span class="k">class</span> <span class="nc">StructureLGS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureLGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of LGSs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
        <span class="sd">&quot;&quot;&quot;Height of natural stars (NGS and science objects). Default value is 10.e20.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span>
        <span class="sd">&quot;&quot;&quot;Relative weight of each LGS. By default all have the same weight.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="sd">&quot;&quot;&quot;Permutations of LGSs indices (e.g. for 4 LGSs: [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)]).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncombilgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of LGSs indices permutations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Up to the specified numberof corrected modes, except the piston, tip and tilt.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must chose 1 or more CPUs&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setlgspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lgspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set LGS coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">lgspos</span>

    <span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphilgs.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;LGS structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read structure function from ASCII file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_lgscoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">coefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;quick&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correl_swsw</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;accurate&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chassat</span><span class="o">.</span><span class="n">correl_osos_general</span><span class="p">([</span><span class="n">alpha</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">,</span> <span class="n">dr0</span> <span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">num_zern1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_zern2</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">gd_echelle</span> <span class="o">=</span> <span class="mf">25.</span><span class="p">,</span> <span class="n">borne_min</span> <span class="o">=</span> <span class="mf">7.e-3</span><span class="p">,</span><span class="n">npas</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Integrator must be a choice of &#39;accurate&#39; or &#39;quick&#39; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefmatrix</span><span class="p">,</span> <span class="n">modes</span>

    <span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute covariance matrix of Zernike coefficients</span>

<span class="sd">        The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">        two sources sepparated by alpha at heights h1 and h2</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        h1: float  </span>
<span class="sd">            height of the first source in m  </span>
<span class="sd">        h2: float  </span>
<span class="sd">            height of the first source in m  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        lgscoefmatrix: numpy array  </span>
<span class="sd">            matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
        <span class="c1">#modes = []</span>
        <span class="c1">#for i in np.arange(4,self.n_zernike):</span>
        <span class="c1">#    for j in np.arange(i,self.n_zernike):</span>
        <span class="c1">#        if self.zcoef_mask[j-2,i-2]:</span>
        <span class="c1">#            modes.append((i,j))</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
                <span class="n">start_i</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">step</span>
                <span class="n">end_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">modes_split</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">start_i</span><span class="p">:</span><span class="n">end_i</span><span class="p">]</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_lgscoef</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">modes_split</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)))</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
                <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                    <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lgscoefmatrix</span>

    <span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a term of the LGS structure function corresponding to the</span>
<span class="sd">        correlation between two sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        gamma: float  </span>
<span class="sd">            angle between the vectors defined b the two sources  </span>
<span class="sd">        h1: float  </span>
<span class="sd">            height of the first source in m  </span>
<span class="sd">        h2: float  </span>
<span class="sd">            height of the first source in m  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        structure function term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lgscoefmatrix</span><span class="p">)</span>
        <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">lgscoefmatrix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">lgsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">lgsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">lgsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lgs_term1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute first term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing first term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term1</span>

    <span class="k">def</span> <span class="nf">_lgs_term2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Second term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing second term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_lgs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">):</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">,</span><span class="n">i_lgs</span><span class="p">],</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">term2</span>

    <span class="k">def</span> <span class="nf">_lgs_term3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Third term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing third term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lgs_term4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fourth term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing fourth term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">b_lgs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncombilgs</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="n">term4</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">,</span><span class="n">r_idx</span><span class="p">],</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term4</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute LGS anisoplanatism structure function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        objpos: list of lists  </span>
<span class="sd">             coordinates of the science obect (posiiton where to compute the PSF) (in arcsec)  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphilgs: numpy array  </span>
<span class="sd">            LGS anisoplanatism structure function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing LGS structure function using </span><span class="si">%s</span><span class="s2"> CPUs.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">data1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term1</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term1</span><span class="p">)</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term2</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term2</span><span class="p">)</span>
        <span class="n">key3</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span> 
        <span class="n">data3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term3</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term3</span><span class="p">)</span>
        <span class="n">key4</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs4&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term4</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span>


<span class="k">class</span> <span class="nc">StructureNGS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureNGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
        <span class="sd">&quot;&quot;&quot;Height of the NGS in m. Deafult is 10.e20.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Tip and tilt only.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setngspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set NGS coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>

    <span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphings.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;NGS structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_ngscoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">coefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;quick&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correl_swsw</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;accurate&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chassat</span><span class="o">.</span><span class="n">correl_osos_general</span><span class="p">([</span><span class="n">alpha</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">,</span> <span class="n">dr0</span> <span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">num_zern1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_zern2</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">gd_echelle</span> <span class="o">=</span> <span class="mf">25.</span><span class="p">,</span> <span class="n">borne_min</span> <span class="o">=</span> <span class="mf">7.e-3</span><span class="p">,</span><span class="n">npas</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Integrator must be a choice of &#39;accurate&#39; or &#39;quick&#39; &quot;</span><span class="p">)</span>
            <span class="c1">#coefmatrix[idx] = self.correl_swsw(alpha, i, j, self.hngs, self.hngs)</span>
            <span class="c1">#coefmatrix[idx] = chassat.correl_osos_general([alpha], self.pupil_diameter, self.hngs, self.hngs, self.cn2, self.h_profile, dr0 =1., num_zern1 = i, num_zern2 = j, gd_echelle = 25., borne_min = 7.e-3,npas = 100)</span>
        <span class="k">return</span> <span class="n">coefmatrix</span><span class="p">,</span> <span class="n">modes</span>

    <span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute covariance matrix of Zernike coefficients</span>

<span class="sd">        The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">        two sources sepparated by alpha at NGS height</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ngscoefmatrix: numpy array  </span>
<span class="sd">            matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ngscoef</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ngscoefmatrix</span>

    <span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a term of the NGS structure function corresponding to the</span>
<span class="sd">        correlation between two sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        gamma: float  </span>
<span class="sd">            angle between the vectors defined b the two sources  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        structure function term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;NGS&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ngscoefmatrix</span><span class="p">)</span>
        <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">ngscoefmatrix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">ngsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">ngsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">ngsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ngs_term1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute first term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing first term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term1</span>

    <span class="k">def</span> <span class="nf">_ngs_term2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Second term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing second term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_ngs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">):</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">,</span><span class="n">i_ngs</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">gammangs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">])</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">term2</span>

    <span class="k">def</span> <span class="nf">_ngs_term3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Third term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing third term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ngs_term4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fourth term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing fourth term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">b_ngs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncombings</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="n">term4</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">,</span><span class="n">r_idx</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">betangs</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">term4</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute NGS anisoplanatism structure function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        objpos: list of lists  </span>
<span class="sd">             coordinates of the science obect (posiiton where to compute the PSF)  </span>
<span class="sd">        ngspos: list of lists  </span>
<span class="sd">            coordinates of the NGS(s) (in arcsec)  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphings: numpy array  </span>
<span class="sd">            NGS anisoplanatism structure function  </span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        hngs = 10.e20 #try later with infinite</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing NGS structure function.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ngs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncombings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betangs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term1</span><span class="p">()</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term2</span><span class="p">()</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term3</span><span class="p">()</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_NGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_ngs_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2"> and NGS at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span>


<span class="k">class</span> <span class="nc">Atmosphere</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing an atmosphere</span>

<span class="sd">    Serves as a container of atmospheric variables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rzero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cn2_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">h_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outer_scale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial values for the attributes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rzero: float  </span>
<span class="sd">            turbulence coherence length (in m).  </span>
<span class="sd">        cn2_profile: list of floats  </span>
<span class="sd">            Cn2 profile of turbulence (normalized to one).  </span>
<span class="sd">        h_profile: list of floats  </span>
<span class="sd">            height of atmospheric layers of Cn2 profile (in m).  </span>
<span class="sd">        outer_scale: float  </span>
<span class="sd">            turbulence outer scale (in m).  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzero</span> <span class="o">=</span> <span class="n">rzero</span>
        <span class="sd">&quot;&quot;&quot;turbulence coherence length (in m)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cn2_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_profile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cn2_profile</span> <span class="o">=</span> <span class="n">cn2_profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">h_profile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cn2 profile and height profile must be of same size&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">outer_scale</span>
        <span class="sd">&quot;&quot;&quot;turbulence outer scale (in m)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">AOsystem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the AO system</span>

<span class="sd">    Handler of AO systems parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aofile</span><span class="o">=</span><span class="s2">&quot;aofile.json&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">aofile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Name of file containing the `rpsfpy.rpsf.AOsystem.systems` dictionary (**aofile.json** by default)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dictionary containing specifications of AO systems.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print known AO systems&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">key</span>
            <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;LGSs coordinates = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;LGSs height = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Corrected Zernike modes = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Telescope diameter = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get parameters for a given AO system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgspos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgsheight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zmodes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">diameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial values for the attributes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name, string:string  </span>
<span class="sd">            name of AO system:key to `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">        lgspos: list of lists  </span>
<span class="sd">            positions on the LGSs in arcsec.  </span>
<span class="sd">        lgsheight: float  </span>
<span class="sd">            height of LGSs in m.  </span>
<span class="sd">        zmodes: int  </span>
<span class="sd">            number of Zernike modes corrected by AO system.  </span>
<span class="sd">        diameter: float  </span>
<span class="sd">            diameter of pupil in m.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgspos</span><span class="p">,</span> <span class="n">lgsheight</span><span class="p">,</span> <span class="n">zmodes</span><span class="p">,</span> <span class="n">diameter</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Name of AO system must be a string.&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">Pclib</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Library of pre-computed structure functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libfile</span><span class="o">=</span><span class="s2">&quot;pclib.json&quot;</span><span class="p">,</span> <span class="n">libdir</span><span class="o">=</span><span class="s2">&quot;pcdata&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">libdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="p">,</span> <span class="n">libfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading Pre-computed libary to dictionary.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pre-computed library file does not exist, creating new...&quot;</span><span class="p">)</span>
                <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">getfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a structure function from the library.</span>
<span class="sd">        Returns None if the function is not in the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving structure function...&quot;</span><span class="p">)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">structure_function</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">structure_function</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No structure function found for key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>                
        <span class="k">return</span> <span class="bp">None</span>
            
    <span class="k">def</span> <span class="nf">isknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the structure function is already in the library&quot;&quot;&quot;</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove keys containing the input string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing file </span><span class="si">%s</span><span class="s2"> from library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> not found in library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="k">pass</span>
                <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing key </span><span class="si">%s</span><span class="s2"> from libary.&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a pre-computed structure function to the database</span>

<span class="sd">        The id_key must be a tuple containing the variables:</span>
<span class="sd">        structure function identifier</span>
<span class="sd">        ao system name</span>
<span class="sd">        number of atmospheric layers</span>
<span class="sd">        number of corrected Zernike modes</span>
<span class="sd">        diameter of pupil in pixels</span>
<span class="sd">        Zernike integrator identifier</span>

<span class="sd">        the data_values are other parameters necessary to compute the </span>
<span class="sd">        LGS sructure functions (the fitting error structure function</span>
<span class="sd">        can be computed with the information contained in id_key):</span>
<span class="sd">        cn2 profile</span>
<span class="sd">        height profile</span>
<span class="sd">        distance between sources</span>
<span class="sd">        angle between sources</span>
<span class="sd">        outer scale value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#new_key = (id_key[0], id_key[1], str(id_key[2]), str(id_key[3]), str(id_key[4]))</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="c1">#file_name = &#39;&#39;.join(new_key)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isknown</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">id_key</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="n">data_array</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tried to add Structure function already in library.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to existing key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">])</span>
                <span class="n">new_file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to new key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">]]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">StructureFit</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitting error structure function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureFit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Fitting error structure function&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphifit.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Fitting error structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_computefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc_constant</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fitting error structure function&quot;&quot;&quot;</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">polar2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">])</span>
        <span class="n">radial</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span>
        <span class="n">tot_correletion_aiaj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">Fc</span> <span class="o">=</span> <span class="n">fc_constant</span> <span class="o">*</span> <span class="p">(</span><span class="n">radial</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">):</span>
                <span class="n">lower_bound</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="p">)),</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="mf">150.</span><span class="p">)</span>
                <span class="n">tot_correletion_aiaj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.023</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="mf">11.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">tot_correletion_aiaj</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc_constant</span><span class="o">=</span><span class="mf">0.37</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute fitting error structure function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fc_constant: float  </span>
<span class="sd">             constant used in the approximation to the structure function  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphifit: numpy array  </span>
<span class="sd">            fitting error structure function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Fitting error structure function.&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computefit</span><span class="p">(</span><span class="n">fc_constant</span><span class="p">)</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">dfit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">dfit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_FIT&quot;</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving Fitting error structure function in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span>


<span class="k">class</span> <span class="nc">Reconstruct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PSF estimation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;accurate&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PSF estimation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pixdiam: int  </span>
<span class="sd">            Diameter of the pupil in pixels. The total size of the final image will be twice this value  </span>
<span class="sd">        aoname: string  </span>
<span class="sd">            name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">        ngspos: list of lists  </span>
<span class="sd">            coordinates of the NGS(s) (in arcsec)  </span>
<span class="sd">        atmosphere: object  </span>
<span class="sd">            Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        parallel: int or &#39;auto&#39;, optional  </span>
<span class="sd">            number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        debug: bool  </span>
<span class="sd">            If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span> <span class="o">=</span> <span class="n">aoname</span>
        <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>               
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
        <span class="sd">&quot;&quot;&quot;coordinates of the NGS(s) (in arcsec)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.Atmosphere` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span> <span class="o">=</span> <span class="n">StructureNGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureNGS` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span> <span class="o">=</span> <span class="n">StructureLGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureLGS` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span> <span class="o">=</span> <span class="n">StructureFit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureFit` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span>
        <span class="sd">&quot;&quot;&quot;Telescope pupil diameter (in m).&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">lgspos</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs height: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">hlgs</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Zernike modes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with pupil diameter: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Cn2 profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">cn2</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with height profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with outer scale: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">strut_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">dlgs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dngs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dfit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute structure functions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dlgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dlgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dngs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dngs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dfit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span>

    <span class="k">def</span> <span class="nf">otf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute OTF from Structrure functions</span>
<span class="sd">        </span>
<span class="sd">        This method is called to obtain estimates of OTFs for a given set of positions</span>
<span class="sd">        in the FoV and a given wavelength. By default, the OTFs are sampled at the Nyquist</span>
<span class="sd">        rate.</span>

<span class="sd">        Note that the default size of the image, in pixels, is an instance attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">                positions in the FoV (in arcsec) in which to estimate the OTF.  </span>
<span class="sd">        wavelength: float  </span>
<span class="sd">                wavelength of in nm  </span>
<span class="sd">        out: string, optional  </span>
<span class="sd">                Name of output file. If set, the output OTFs will be written to </span>
<span class="sd">                a FITS file as a &quot;data cube&quot;, i.e. the OTFs will be stacked in an</span>
<span class="sd">                3D array.  </span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        otf_array: ndarray  </span>
<span class="sd">                OTFs stacked in a 3D Numpy array.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r0_500</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">rzero</span>
        <span class="n">r0_wv</span> <span class="o">=</span> <span class="n">r0_500</span> <span class="o">*</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">/</span> <span class="mf">500.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">6.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
        <span class="n">dr0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">/</span> <span class="n">r0_wv</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">objectpos</span> <span class="ow">in</span> <span class="n">objectlist</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions for object with coordinates </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">objectpos</span><span class="p">))</span>
            <span class="n">dphilgs</span><span class="p">,</span> <span class="n">dphings</span><span class="p">,</span> <span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strut_functions</span><span class="p">(</span><span class="n">objectpos</span><span class="p">)</span>
            <span class="n">dphi_tot</span> <span class="o">=</span> <span class="n">dphings</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dphilgs</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dfitting</span> <span class="o">*</span> <span class="n">dr0</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
            <span class="n">ao</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dphi_tot</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">otf</span> <span class="o">=</span> <span class="n">ac</span> <span class="o">*</span> <span class="n">ao</span>
            <span class="n">otf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">otf</span><span class="p">)</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving OTFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">otf_array</span>

    <span class="k">def</span> <span class="nf">otf_fromfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute PSF from Structrure functions.</span>

<span class="sd">        This method is called to obtain estimates of PSFs for a given set of positions</span>
<span class="sd">        in the FoV and a given wavelength. By default, the PSFs are sampled at the Nyquist</span>
<span class="sd">        rate. The PSFs can be outputted to a FITS file.</span>

<span class="sd">        Note that the default size of the image, in pixels, is an instance attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">                positions in the FoV (in arcsec) in which to estimate the PSF.  </span>
<span class="sd">        wavelength: float  </span>
<span class="sd">                wavelength of the PSF in nm  </span>
<span class="sd">        scale: float, optional  </span>
<span class="sd">                factor of increase in the PSF sampling rate relative to the Nyquist</span>
<span class="sd">                limit. default is 1 (Nyquist rate).  </span>
<span class="sd">        out: string, optional</span>
<span class="sd">                Name of output file. If set, the output PSFs will be written to </span>
<span class="sd">                a FITS file as a &quot;data cube&quot;, i.e. the PSFs will be stacked in an</span>
<span class="sd">                3D array.  </span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        psf_array: ndarray  </span>
<span class="sd">                PSFs stacked in a 3D Numpy array.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing PSFs for wavelength = </span><span class="si">%s</span><span class="s2"> nm&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale must be &gt;= 1&quot;</span><span class="p">)</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">otf</span><span class="p">(</span><span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">otf</span> <span class="ow">in</span> <span class="n">otf_array</span><span class="p">:</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resample</span><span class="p">(</span><span class="n">otf</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
            <span class="n">psf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;pscale&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving PSFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">psf_array</span>

    <span class="k">def</span> <span class="nf">_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute plate scale in arc sec per pixel, lamda in nm&quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1.e-9</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">diameter</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">206264.8</span> <span class="o">*</span> <span class="n">theta</span>

    <span class="k">def</span> <span class="nf">_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otf</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resample the PSF&quot;&quot;&quot;</span>
        <span class="n">n_otf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">n_pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_otf</span> <span class="o">*</span> <span class="n">zoom</span> <span class="o">-</span> <span class="n">n_otf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">n_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pad</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">otf</span><span class="p">,</span> <span class="n">n_pad</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1">#Load library of pre-computed structure functions</span>
<span class="n">pclib</span> <span class="o">=</span> <span class="n">Pclib</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Instance of  `rpsfpy.rpsf.Pclib`: load pre-computed structure function terms&quot;&quot;&quot;</span>

<span class="c1">#Load library of AO systems</span>
<span class="n">ao_systems</span> <span class="o">=</span> <span class="n">AOsystem</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Instance of  `rpsfpy.rpsf.AOsystem`: load known AO systems&quot;&quot;&quot;</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="rpsfpy.rpsf.ao_systems" class="name">var <span class="ident">ao_systems</span></p>
      
  
    <div class="desc"><p>Instance of  <a href="#rpsfpy.rpsf.AOsystem"><code>AOsystem</code></a>: load known AO systems</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="rpsfpy.rpsf.logger" class="name">var <span class="ident">logger</span></p>
      
  
    <div class="desc"><p>show the module activity in the terminal and store debug details in a log file - <strong>debug.log</strong>.</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="rpsfpy.rpsf.pclib" class="name">var <span class="ident">pclib</span></p>
      
  
    <div class="desc"><p>Instance of  <a href="#rpsfpy.rpsf.Pclib"><code>Pclib</code></a>: load pre-computed structure function terms</p></div>
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.fftcorr">
    <p>def <span class="ident">fftcorr</span>(</p><p>X, Y, s=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute cross-correlation or autocorrelation using FFT.</p>
<h2>Parameters</h2>
<p>X: numpy array</p>
<p>Y: numpy array</p>
<p>s: sequence of ints, optional
   shape of the output array, this passed to numpy's fft.fft2 function</p>
<h2>Returns</h2>
<p>out: numpy array
     Correlation matrix of X and Y</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.fftcorr', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.fftcorr" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">fftcorr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute cross-correlation or autocorrelation using FFT.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X: numpy array</span>
<span class="sd">    </span>
<span class="sd">    Y: numpy array</span>

<span class="sd">    s: sequence of ints, optional</span>
<span class="sd">       shape of the output array, this passed to numpy&#39;s fft.fft2 function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    out: numpy array</span>
<span class="sd">         Correlation matrix of X and Y</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;shape&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">f1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">f2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Input must be two 2d arrays&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Input must be two 2d arrays&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.polar2">
    <p>def <span class="ident">polar2</span>(</p><p>radius, oc=0.0, fourpixels=True, leq=False, length=None, center=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute pupil mask and polar coordinates.</p>
<p>Assumes a circular pupil with some radius given in pixels and computes
arrays containing grids of polar coordinates rho and phi and an array
containing the pupil mask (i.e. 1 inside the pupil and 0 outside).</p>
<h2>Parameters</h2>
<p>radius: int or float<br />
    radius of pupil in pixels<br />
oc: float, optional<br />
    size of central occultation for pupil mask (default=0.)<br />
fourpixels: bool<br />
    if True and length is &lt; 0 or missing then the centre of the pupil is
    in the intersection of the four central pixels and the length set to
    an even number, if False the centre is in central pixel and length set to
    an odd number (of pixels)<br />
leq: bool<br />
    if True the border of mask is included (points &lt;= radius), if False it
    is not (points &lt; radius)<br />
length: float, optional<br />
    length of pupil in physical units, computed according to fourpixels argument
    if not given<br />
center: array_like, optional<br />
    coordinates of pupil center, set to half of length if not given  </p>
<h2>Returns</h2>
<p>rho: ndarray<br />
    Array of rho coordinates<br />
phi: ndarray<br />
    Array of phi coordinates<br />
mask: ndarray<br />
    Array of pupil's mask (i.e. 1 inside the pupil and 0 outside)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.polar2', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.polar2" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">polar2</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">oc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fourpixels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">leq</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Compute pupil mask and polar coordinates.</span>

<span class="sd">    Assumes a circular pupil with some radius given in pixels and computes</span>
<span class="sd">    arrays containing grids of polar coordinates rho and phi and an array</span>
<span class="sd">    containing the pupil mask (i.e. 1 inside the pupil and 0 outside).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius: int or float  </span>
<span class="sd">        radius of pupil in pixels  </span>
<span class="sd">    oc: float, optional  </span>
<span class="sd">        size of central occultation for pupil mask (default=0.)  </span>
<span class="sd">    fourpixels: bool  </span>
<span class="sd">        if True and length is &lt; 0 or missing then the centre of the pupil is</span>
<span class="sd">        in the intersection of the four central pixels and the length set to</span>
<span class="sd">        an even number, if False the centre is in central pixel and length set to</span>
<span class="sd">        an odd number (of pixels)  </span>
<span class="sd">    leq: bool  </span>
<span class="sd">        if True the border of mask is included (points &lt;= radius), if False it</span>
<span class="sd">        is not (points &lt; radius)  </span>
<span class="sd">    length: float, optional  </span>
<span class="sd">        length of pupil in physical units, computed according to fourpixels argument</span>
<span class="sd">        if not given  </span>
<span class="sd">    center: array_like, optional  </span>
<span class="sd">        coordinates of pupil center, set to half of length if not given  </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    rho: ndarray  </span>
<span class="sd">        Array of rho coordinates  </span>
<span class="sd">    phi: ndarray  </span>
<span class="sd">        Array of phi coordinates  </span>
<span class="sd">    mask: ndarray  </span>
<span class="sd">        Array of pupil&#39;s mask (i.e. 1 inside the pupil and 0 outside)  </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fourpixels</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cy</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">cx</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="n">radius</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">rho</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leq</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">oc</span><span class="p">),</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">mask</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="rpsfpy.rpsf.AOsystem" class="name">class <span class="ident">AOsystem</span></p>
      
  
    <div class="desc"><p>Class representing the AO system</p>
<p>Handler of AO systems parameters.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">AOsystem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the AO system</span>

<span class="sd">    Handler of AO systems parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aofile</span><span class="o">=</span><span class="s2">&quot;aofile.json&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">aofile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Name of file containing the `rpsfpy.rpsf.AOsystem.systems` dictionary (**aofile.json** by default)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dictionary containing specifications of AO systems.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print known AO systems&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">key</span>
            <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>
            <span class="k">print</span> <span class="s2">&quot;LGSs coordinates = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;LGSs height = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Corrected Zernike modes = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;Telescope diameter = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get parameters for a given AO system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgspos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgsheight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zmodes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">diameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial values for the attributes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name, string:string  </span>
<span class="sd">            name of AO system:key to `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">        lgspos: list of lists  </span>
<span class="sd">            positions on the LGSs in arcsec.  </span>
<span class="sd">        lgsheight: float  </span>
<span class="sd">            height of LGSs in m.  </span>
<span class="sd">        zmodes: int  </span>
<span class="sd">            number of Zernike modes corrected by AO system.  </span>
<span class="sd">        diameter: float  </span>
<span class="sd">            diameter of pupil in m.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgspos</span><span class="p">,</span> <span class="n">lgsheight</span><span class="p">,</span> <span class="n">zmodes</span><span class="p">,</span> <span class="n">diameter</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Name of AO system must be a string.&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.AOsystem">AOsystem</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.AOsystem.aofile" class="name">var <span class="ident">aofile</span></p>
            

            
  
    <div class="desc"><p>Name of file containing the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary (<strong>aofile.json</strong> by default)</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.AOsystem.systems" class="name">var <span class="ident">systems</span></p>
            

            
  
    <div class="desc"><p>Dictionary containing specifications of AO systems.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.AOsystem.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, aofile=&#39;aofile.json&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aofile</span><span class="o">=</span><span class="s2">&quot;aofile.json&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">aofile</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Name of file containing the `rpsfpy.rpsf.AOsystem.systems` dictionary (**aofile.json** by default)&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;Dictionary containing specifications of AO systems.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.AOsystem.add">
    <p>def <span class="ident">add</span>(</p><p>self, name=None, lgspos=None, lgsheight=None, zmodes=None, diameter=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Initial values for the attributes.</p>
<h2>Parameters</h2>
<p>name, string:string<br />
    name of AO system:key to <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.<br />
lgspos: list of lists<br />
    positions on the LGSs in arcsec.<br />
lgsheight: float<br />
    height of LGSs in m.<br />
zmodes: int<br />
    number of Zernike modes corrected by AO system.<br />
diameter: float<br />
    diameter of pupil in m.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem.add', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem.add" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgspos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lgsheight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zmodes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">diameter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initial values for the attributes.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name, string:string  </span>
<span class="sd">        name of AO system:key to `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">    lgspos: list of lists  </span>
<span class="sd">        positions on the LGSs in arcsec.  </span>
<span class="sd">    lgsheight: float  </span>
<span class="sd">        height of LGSs in m.  </span>
<span class="sd">    zmodes: int  </span>
<span class="sd">        number of Zernike modes corrected by AO system.  </span>
<span class="sd">    diameter: float  </span>
<span class="sd">        diameter of pupil in m.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgspos</span><span class="p">,</span> <span class="n">lgsheight</span><span class="p">,</span> <span class="n">zmodes</span><span class="p">,</span> <span class="n">diameter</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aofile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Name of AO system must be a string.&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.AOsystem.get">
    <p>def <span class="ident">get</span>(</p><p>self, key)</p>
    </div>
    

    
  
    <div class="desc"><p>Get parameters for a given AO system</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem.get', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem.get" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get parameters for a given AO system&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.AOsystem.remove">
    <p>def <span class="ident">remove</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Not implemented</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem.remove', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem.remove" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.AOsystem.view">
    <p>def <span class="ident">view</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Print known AO systems</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.AOsystem.view', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.AOsystem.view" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print known AO systems&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">key</span>
        <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>
        <span class="k">print</span> <span class="s2">&quot;LGSs coordinates = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;LGSs height = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Corrected Zernike modes = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Telescope diameter = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;------------&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.Atmosphere" class="name">class <span class="ident">Atmosphere</span></p>
      
  
    <div class="desc"><p>Class representing an atmosphere</p>
<p>Serves as a container of atmospheric variables</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Atmosphere', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Atmosphere" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Atmosphere</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing an atmosphere</span>

<span class="sd">    Serves as a container of atmospheric variables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rzero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cn2_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">h_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outer_scale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial values for the attributes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rzero: float  </span>
<span class="sd">            turbulence coherence length (in m).  </span>
<span class="sd">        cn2_profile: list of floats  </span>
<span class="sd">            Cn2 profile of turbulence (normalized to one).  </span>
<span class="sd">        h_profile: list of floats  </span>
<span class="sd">            height of atmospheric layers of Cn2 profile (in m).  </span>
<span class="sd">        outer_scale: float  </span>
<span class="sd">            turbulence outer scale (in m).  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rzero</span> <span class="o">=</span> <span class="n">rzero</span>
        <span class="sd">&quot;&quot;&quot;turbulence coherence length (in m)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cn2_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_profile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cn2_profile</span> <span class="o">=</span> <span class="n">cn2_profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">h_profile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cn2 profile and height profile must be of same size&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">outer_scale</span>
        <span class="sd">&quot;&quot;&quot;turbulence outer scale (in m)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.Atmosphere">Atmosphere</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.Atmosphere.outer_scale" class="name">var <span class="ident">outer_scale</span></p>
            

            
  
    <div class="desc"><p>turbulence outer scale (in m)</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Atmosphere.rzero" class="name">var <span class="ident">rzero</span></p>
            

            
  
    <div class="desc"><p>turbulence coherence length (in m)</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Atmosphere.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, rzero=None, cn2_profile=None, h_profile=None, outer_scale=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Initial values for the attributes.</p>
<h2>Parameters</h2>
<p>rzero: float<br />
    turbulence coherence length (in m).<br />
cn2_profile: list of floats<br />
    Cn2 profile of turbulence (normalized to one).<br />
h_profile: list of floats<br />
    height of atmospheric layers of Cn2 profile (in m).<br />
outer_scale: float<br />
    turbulence outer scale (in m).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Atmosphere.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Atmosphere.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rzero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cn2_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">h_profile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outer_scale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initial values for the attributes.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rzero: float  </span>
<span class="sd">        turbulence coherence length (in m).  </span>
<span class="sd">    cn2_profile: list of floats  </span>
<span class="sd">        Cn2 profile of turbulence (normalized to one).  </span>
<span class="sd">    h_profile: list of floats  </span>
<span class="sd">        height of atmospheric layers of Cn2 profile (in m).  </span>
<span class="sd">    outer_scale: float  </span>
<span class="sd">        turbulence outer scale (in m).  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rzero</span> <span class="o">=</span> <span class="n">rzero</span>
    <span class="sd">&quot;&quot;&quot;turbulence coherence length (in m)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cn2_profile</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_profile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn2_profile</span> <span class="o">=</span> <span class="n">cn2_profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">h_profile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cn2 profile and height profile must be of same size&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">outer_scale</span>
    <span class="sd">&quot;&quot;&quot;turbulence outer scale (in m)&quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Atmosphere.readfromfile">
    <p>def <span class="ident">readfromfile</span>(</p><p>self, infile=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Not implemented</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Atmosphere.readfromfile', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Atmosphere.readfromfile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.Pclib" class="name">class <span class="ident">Pclib</span></p>
      
  
    <div class="desc"><p>Library of pre-computed structure functions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Pclib</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Library of pre-computed structure functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libfile</span><span class="o">=</span><span class="s2">&quot;pclib.json&quot;</span><span class="p">,</span> <span class="n">libdir</span><span class="o">=</span><span class="s2">&quot;pcdata&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">libdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="p">,</span> <span class="n">libfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading Pre-computed libary to dictionary.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pre-computed library file does not exist, creating new...&quot;</span><span class="p">)</span>
                <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">getfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a structure function from the library.</span>
<span class="sd">        Returns None if the function is not in the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving structure function...&quot;</span><span class="p">)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">structure_function</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">structure_function</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No structure function found for key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>                
        <span class="k">return</span> <span class="bp">None</span>
            
    <span class="k">def</span> <span class="nf">isknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the structure function is already in the library&quot;&quot;&quot;</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove keys containing the input string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_key</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing file </span><span class="si">%s</span><span class="s2"> from library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> not found in library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="k">pass</span>
                <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing key </span><span class="si">%s</span><span class="s2"> from libary.&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a pre-computed structure function to the database</span>

<span class="sd">        The id_key must be a tuple containing the variables:</span>
<span class="sd">        structure function identifier</span>
<span class="sd">        ao system name</span>
<span class="sd">        number of atmospheric layers</span>
<span class="sd">        number of corrected Zernike modes</span>
<span class="sd">        diameter of pupil in pixels</span>
<span class="sd">        Zernike integrator identifier</span>

<span class="sd">        the data_values are other parameters necessary to compute the </span>
<span class="sd">        LGS sructure functions (the fitting error structure function</span>
<span class="sd">        can be computed with the information contained in id_key):</span>
<span class="sd">        cn2 profile</span>
<span class="sd">        height profile</span>
<span class="sd">        distance between sources</span>
<span class="sd">        angle between sources</span>
<span class="sd">        outer scale value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#new_key = (id_key[0], id_key[1], str(id_key[2]), str(id_key[3]), str(id_key[4]))</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
        <span class="c1">#file_name = &#39;&#39;.join(new_key)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isknown</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">id_key</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="n">data_array</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tried to add Structure function already in library.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to existing key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">])</span>
                <span class="n">new_file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to new key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">]]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.Pclib">Pclib</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.Pclib.libdir" class="name">var <span class="ident">libdir</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Pclib.libfile" class="name">var <span class="ident">libfile</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Pclib.sfuncs" class="name">var <span class="ident">sfuncs</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Pclib.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, libfile=&#39;pclib.json&#39;, libdir=&#39;pcdata&#39;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libfile</span><span class="o">=</span><span class="s2">&quot;pclib.json&quot;</span><span class="p">,</span> <span class="n">libdir</span><span class="o">=</span><span class="s2">&quot;pcdata&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">libdir</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">libfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span> <span class="p">,</span> <span class="n">libfile</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading Pre-computed libary to dictionary.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pre-computed library file does not exist, creating new...&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Pclib.add">
    <p>def <span class="ident">add</span>(</p><p>self, id_key=None, data_values=None, structure_function=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Add a pre-computed structure function to the database</p>
<p>The id_key must be a tuple containing the variables:
structure function identifier
ao system name
number of atmospheric layers
number of corrected Zernike modes
diameter of pupil in pixels
Zernike integrator identifier</p>
<p>the data_values are other parameters necessary to compute the 
LGS sructure functions (the fitting error structure function
can be computed with the information contained in id_key):
cn2 profile
height profile
distance between sources
angle between sources
outer scale value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib.add', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib.add" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a pre-computed structure function to the database</span>
<span class="sd">    The id_key must be a tuple containing the variables:</span>
<span class="sd">    structure function identifier</span>
<span class="sd">    ao system name</span>
<span class="sd">    number of atmospheric layers</span>
<span class="sd">    number of corrected Zernike modes</span>
<span class="sd">    diameter of pupil in pixels</span>
<span class="sd">    Zernike integrator identifier</span>
<span class="sd">    the data_values are other parameters necessary to compute the </span>
<span class="sd">    LGS sructure functions (the fitting error structure function</span>
<span class="sd">    can be computed with the information contained in id_key):</span>
<span class="sd">    cn2 profile</span>
<span class="sd">    height profile</span>
<span class="sd">    distance between sources</span>
<span class="sd">    angle between sources</span>
<span class="sd">    outer scale value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#new_key = (id_key[0], id_key[1], str(id_key[2]), str(id_key[3]), str(id_key[4]))</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="c1">#file_name = &#39;&#39;.join(new_key)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isknown</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">id_key</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="n">data_array</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tried to add Structure function already in library.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to existing key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
            <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">])</span>
            <span class="n">new_file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_elements</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding new structure function to new key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">structure_function</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">new_key</span><span class="o">+</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="n">data_array</span><span class="p">]]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Pclib.getfunction">
    <p>def <span class="ident">getfunction</span>(</p><p>self, id_key=None, data_values=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a structure function from the library.
Returns None if the function is not in the library.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib.getfunction', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib.getfunction" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">getfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a structure function from the library.</span>
<span class="sd">    Returns None if the function is not in the library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving structure function...&quot;</span><span class="p">)</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_values</span>
    <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">structure_function</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">structure_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning structure function for key </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">structure_function</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No structure function found for key </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>                
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Pclib.isknown">
    <p>def <span class="ident">isknown</span>(</p><p>self, id_key=None, data_array=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Check if the structure function is already in the library</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib.isknown', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib.isknown" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">isknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_array</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the structure function is already in the library&quot;&quot;&quot;</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_key</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span>
    <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Pclib.remove">
    <p>def <span class="ident">remove</span>(</p><p>self, id_key=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove keys containing the input string.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Pclib.remove', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Pclib.remove" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove keys containing the input string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_key</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elements</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libdir</span><span class="p">,</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing file </span><span class="si">%s</span><span class="s2"> from library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">%s</span><span class="s2"> not found in library.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="k">pass</span>
            <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing key </span><span class="si">%s</span><span class="s2"> from libary.&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">libfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Pre-computed structure functions library file.&quot;</span><span class="p">)</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.Reconstruct" class="name">class <span class="ident">Reconstruct</span></p>
      
  
    <div class="desc"><p>PSF estimation</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Reconstruct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PSF estimation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;accurate&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PSF estimation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pixdiam: int  </span>
<span class="sd">            Diameter of the pupil in pixels. The total size of the final image will be twice this value  </span>
<span class="sd">        aoname: string  </span>
<span class="sd">            name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">        ngspos: list of lists  </span>
<span class="sd">            coordinates of the NGS(s) (in arcsec)  </span>
<span class="sd">        atmosphere: object  </span>
<span class="sd">            Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        parallel: int or &#39;auto&#39;, optional  </span>
<span class="sd">            number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        debug: bool  </span>
<span class="sd">            If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span> <span class="o">=</span> <span class="n">aoname</span>
        <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>               
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
        <span class="sd">&quot;&quot;&quot;coordinates of the NGS(s) (in arcsec)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.Atmosphere` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span> <span class="o">=</span> <span class="n">StructureNGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureNGS` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span> <span class="o">=</span> <span class="n">StructureLGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureLGS` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span> <span class="o">=</span> <span class="n">StructureFit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureFit` class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span>
        <span class="sd">&quot;&quot;&quot;Telescope pupil diameter (in m).&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">lgspos</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs height: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">hlgs</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Zernike modes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with pupil diameter: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Cn2 profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">cn2</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with height profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with outer scale: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">strut_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">dlgs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dngs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dfit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute structure functions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dlgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dlgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dngs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dngs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dfit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span>

    <span class="k">def</span> <span class="nf">otf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute OTF from Structrure functions</span>
<span class="sd">        </span>
<span class="sd">        This method is called to obtain estimates of OTFs for a given set of positions</span>
<span class="sd">        in the FoV and a given wavelength. By default, the OTFs are sampled at the Nyquist</span>
<span class="sd">        rate.</span>

<span class="sd">        Note that the default size of the image, in pixels, is an instance attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">                positions in the FoV (in arcsec) in which to estimate the OTF.  </span>
<span class="sd">        wavelength: float  </span>
<span class="sd">                wavelength of in nm  </span>
<span class="sd">        out: string, optional  </span>
<span class="sd">                Name of output file. If set, the output OTFs will be written to </span>
<span class="sd">                a FITS file as a &quot;data cube&quot;, i.e. the OTFs will be stacked in an</span>
<span class="sd">                3D array.  </span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        otf_array: ndarray  </span>
<span class="sd">                OTFs stacked in a 3D Numpy array.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r0_500</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">rzero</span>
        <span class="n">r0_wv</span> <span class="o">=</span> <span class="n">r0_500</span> <span class="o">*</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">/</span> <span class="mf">500.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">6.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
        <span class="n">dr0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">/</span> <span class="n">r0_wv</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">objectpos</span> <span class="ow">in</span> <span class="n">objectlist</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions for object with coordinates </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">objectpos</span><span class="p">))</span>
            <span class="n">dphilgs</span><span class="p">,</span> <span class="n">dphings</span><span class="p">,</span> <span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strut_functions</span><span class="p">(</span><span class="n">objectpos</span><span class="p">)</span>
            <span class="n">dphi_tot</span> <span class="o">=</span> <span class="n">dphings</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dphilgs</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dfitting</span> <span class="o">*</span> <span class="n">dr0</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
            <span class="n">ao</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dphi_tot</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">otf</span> <span class="o">=</span> <span class="n">ac</span> <span class="o">*</span> <span class="n">ao</span>
            <span class="n">otf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">otf</span><span class="p">)</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving OTFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">otf_array</span>

    <span class="k">def</span> <span class="nf">otf_fromfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute PSF from Structrure functions.</span>

<span class="sd">        This method is called to obtain estimates of PSFs for a given set of positions</span>
<span class="sd">        in the FoV and a given wavelength. By default, the PSFs are sampled at the Nyquist</span>
<span class="sd">        rate. The PSFs can be outputted to a FITS file.</span>

<span class="sd">        Note that the default size of the image, in pixels, is an instance attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">                positions in the FoV (in arcsec) in which to estimate the PSF.  </span>
<span class="sd">        wavelength: float  </span>
<span class="sd">                wavelength of the PSF in nm  </span>
<span class="sd">        scale: float, optional  </span>
<span class="sd">                factor of increase in the PSF sampling rate relative to the Nyquist</span>
<span class="sd">                limit. default is 1 (Nyquist rate).  </span>
<span class="sd">        out: string, optional</span>
<span class="sd">                Name of output file. If set, the output PSFs will be written to </span>
<span class="sd">                a FITS file as a &quot;data cube&quot;, i.e. the PSFs will be stacked in an</span>
<span class="sd">                3D array.  </span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        psf_array: ndarray  </span>
<span class="sd">                PSFs stacked in a 3D Numpy array.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing PSFs for wavelength = </span><span class="si">%s</span><span class="s2"> nm&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale must be &gt;= 1&quot;</span><span class="p">)</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">otf_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">otf</span><span class="p">(</span><span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">otf</span> <span class="ow">in</span> <span class="n">otf_array</span><span class="p">:</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resample</span><span class="p">(</span><span class="n">otf</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
            <span class="n">psf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;pscale&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving PSFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">psf_array</span>

    <span class="k">def</span> <span class="nf">_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wavelength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute plate scale in arc sec per pixel, lamda in nm&quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1.e-9</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">diameter</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">206264.8</span> <span class="o">*</span> <span class="n">theta</span>

    <span class="k">def</span> <span class="nf">_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otf</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resample the PSF&quot;&quot;&quot;</span>
        <span class="n">n_otf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">n_pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_otf</span> <span class="o">*</span> <span class="n">zoom</span> <span class="o">-</span> <span class="n">n_otf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">n_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pad</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">otf</span><span class="p">,</span> <span class="n">n_pad</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.Reconstruct">Reconstruct</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.Dfit" class="name">var <span class="ident">Dfit</span></p>
            

            
  
    <div class="desc"><p>Instance of <a href="#rpsfpy.rpsf.StructureFit"><code>StructureFit</code></a> class.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.Dlgs" class="name">var <span class="ident">Dlgs</span></p>
            

            
  
    <div class="desc"><p>Instance of <a href="#rpsfpy.rpsf.StructureLGS"><code>StructureLGS</code></a> class.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.Dngs" class="name">var <span class="ident">Dngs</span></p>
            

            
  
    <div class="desc"><p>Instance of <a href="#rpsfpy.rpsf.StructureNGS"><code>StructureNGS</code></a> class.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.ao_system" class="name">var <span class="ident">ao_system</span></p>
            

            
  
    <div class="desc"><p>String with the name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.atmosphere" class="name">var <span class="ident">atmosphere</span></p>
            

            
  
    <div class="desc"><p>Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.diameter" class="name">var <span class="ident">diameter</span></p>
            

            
  
    <div class="desc"><p>Telescope pupil diameter (in m).</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.integrator" class="name">var <span class="ident">integrator</span></p>
            

            
  
    <div class="desc"><p>Integrator used to conpute correlations between Zernike coefficients.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.ngspos" class="name">var <span class="ident">ngspos</span></p>
            

            
  
    <div class="desc"><p>coordinates of the NGS(s) (in arcsec)</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.parallel" class="name">var <span class="ident">parallel</span></p>
            

            
  
    <div class="desc"><p>Number of cores available for the computation of the structure function. Defaults to 'auto': use all available cores.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Reconstruct.pixdiam" class="name">var <span class="ident">pixdiam</span></p>
            

            
  
    <div class="desc"><p>Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Reconstruct.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, pixdiam, aoname, ngspos, atmosphere, parallel=&#39;auto&#39;, integrator=&#39;accurate&#39;, debug=False)</p>
    </div>
    

    
  
    <div class="desc"><p>PSF estimation</p>
<h2>Parameters</h2>
<p>pixdiam: int<br />
    Diameter of the pupil in pixels. The total size of the final image will be twice this value<br />
aoname: string<br />
    name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.<br />
ngspos: list of lists<br />
    coordinates of the NGS(s) (in arcsec)<br />
atmosphere: object<br />
    Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class. Contains variables related to the atmosphere.<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
parallel: int or 'auto', optional<br />
    number of cores available for the computation of the structure function. Defaults to 'auto': use all available cores<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
debug: bool<br />
    If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;accurate&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PSF estimation</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pixdiam: int  </span>
<span class="sd">        Diameter of the pupil in pixels. The total size of the final image will be twice this value  </span>
<span class="sd">    aoname: string  </span>
<span class="sd">        name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.  </span>
<span class="sd">    ngspos: list of lists  </span>
<span class="sd">        coordinates of the NGS(s) (in arcsec)  </span>
<span class="sd">    atmosphere: object  </span>
<span class="sd">        Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">    integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">        integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">    parallel: int or &#39;auto&#39;, optional  </span>
<span class="sd">        number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores  </span>
<span class="sd">    integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">        integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">    debug: bool  </span>
<span class="sd">        If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span> <span class="o">=</span> <span class="n">aoname</span>
    <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>               
    <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
    <span class="sd">&quot;&quot;&quot;coordinates of the NGS(s) (in arcsec)&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
    <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
    <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
    <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.Atmosphere` class.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span> <span class="o">=</span> <span class="n">StructureNGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureNGS` class.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span> <span class="o">=</span> <span class="n">StructureLGS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureLGS` class.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span> <span class="o">=</span> <span class="n">StructureFit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Instance of `rpsfpy.rpsf.StructureFit` class.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span>
    <span class="sd">&quot;&quot;&quot;Telescope pupil diameter (in m).&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">lgspos</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with lgs height: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">hlgs</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Zernike modes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with pupil diameter: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with Cn2 profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">cn2</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with height profile: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions with outer scale: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Reconstruct.otf">
    <p>def <span class="ident">otf</span>(</p><p>self, objectlist, wavelength, out=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute OTF from Structrure functions</p>
<p>This method is called to obtain estimates of OTFs for a given set of positions
in the FoV and a given wavelength. By default, the OTFs are sampled at the Nyquist
rate.</p>
<p>Note that the default size of the image, in pixels, is an instance attribute.</p>
<h2>Parameters</h2>
<p>objectlist: list of lists, tuples or arrays (2 elements)<br />
        positions in the FoV (in arcsec) in which to estimate the OTF.<br />
wavelength: float<br />
        wavelength of in nm<br />
out: string, optional<br />
        Name of output file. If set, the output OTFs will be written to 
        a FITS file as a "data cube", i.e. the OTFs will be stacked in an
        3D array.  </p>
<h2>Returns</h2>
<p>otf_array: ndarray<br />
        OTFs stacked in a 3D Numpy array.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct.otf', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct.otf" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">otf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute OTF from Structrure functions</span>
<span class="sd">    </span>
<span class="sd">    This method is called to obtain estimates of OTFs for a given set of positions</span>
<span class="sd">    in the FoV and a given wavelength. By default, the OTFs are sampled at the Nyquist</span>
<span class="sd">    rate.</span>
<span class="sd">    Note that the default size of the image, in pixels, is an instance attribute.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">            positions in the FoV (in arcsec) in which to estimate the OTF.  </span>
<span class="sd">    wavelength: float  </span>
<span class="sd">            wavelength of in nm  </span>
<span class="sd">    out: string, optional  </span>
<span class="sd">            Name of output file. If set, the output OTFs will be written to </span>
<span class="sd">            a FITS file as a &quot;data cube&quot;, i.e. the OTFs will be stacked in an</span>
<span class="sd">            3D array.  </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    otf_array: ndarray  </span>
<span class="sd">            OTFs stacked in a 3D Numpy array.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r0_500</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">rzero</span>
    <span class="n">r0_wv</span> <span class="o">=</span> <span class="n">r0_500</span> <span class="o">*</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">/</span> <span class="mf">500.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">6.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
    <span class="n">dr0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diameter</span> <span class="o">/</span> <span class="n">r0_wv</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">otf_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">objectpos</span> <span class="ow">in</span> <span class="n">objectlist</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Structure functions for object with coordinates </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">objectpos</span><span class="p">))</span>
        <span class="n">dphilgs</span><span class="p">,</span> <span class="n">dphings</span><span class="p">,</span> <span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strut_functions</span><span class="p">(</span><span class="n">objectpos</span><span class="p">)</span>
        <span class="n">dphi_tot</span> <span class="o">=</span> <span class="n">dphings</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dphilgs</span> <span class="o">*</span> <span class="n">dr0</span> <span class="o">+</span> <span class="n">dfitting</span> <span class="o">*</span> <span class="n">dr0</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
        <span class="n">ao</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dphi_tot</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">otf</span> <span class="o">=</span> <span class="n">ac</span> <span class="o">*</span> <span class="n">ao</span>
        <span class="n">otf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">otf</span><span class="p">)</span>
    <span class="n">otf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">otf_array</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving OTFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">otf_array</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Reconstruct.otf_fromfiles">
    <p>def <span class="ident">otf_fromfiles</span>(</p><p>self, wavelength)</p>
    </div>
    

    
  
    <div class="desc"><p>Not implemented</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct.otf_fromfiles', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct.otf_fromfiles" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">otf_fromfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Not implemented&quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Reconstruct.psf">
    <p>def <span class="ident">psf</span>(</p><p>self, objectlist, wavelength, scale=1, out=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute PSF from Structrure functions.</p>
<p>This method is called to obtain estimates of PSFs for a given set of positions
in the FoV and a given wavelength. By default, the PSFs are sampled at the Nyquist
rate. The PSFs can be outputted to a FITS file.</p>
<p>Note that the default size of the image, in pixels, is an instance attribute.</p>
<h2>Parameters</h2>
<p>objectlist: list of lists, tuples or arrays (2 elements)<br />
        positions in the FoV (in arcsec) in which to estimate the PSF.<br />
wavelength: float<br />
        wavelength of the PSF in nm<br />
scale: float, optional<br />
        factor of increase in the PSF sampling rate relative to the Nyquist
        limit. default is 1 (Nyquist rate).<br />
out: string, optional
        Name of output file. If set, the output PSFs will be written to 
        a FITS file as a "data cube", i.e. the PSFs will be stacked in an
        3D array.  </p>
<h2>Returns</h2>
<p>psf_array: ndarray<br />
        PSFs stacked in a 3D Numpy array.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct.psf', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct.psf" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute PSF from Structrure functions.</span>
<span class="sd">    This method is called to obtain estimates of PSFs for a given set of positions</span>
<span class="sd">    in the FoV and a given wavelength. By default, the PSFs are sampled at the Nyquist</span>
<span class="sd">    rate. The PSFs can be outputted to a FITS file.</span>
<span class="sd">    Note that the default size of the image, in pixels, is an instance attribute.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objectlist: list of lists, tuples or arrays (2 elements)  </span>
<span class="sd">            positions in the FoV (in arcsec) in which to estimate the PSF.  </span>
<span class="sd">    wavelength: float  </span>
<span class="sd">            wavelength of the PSF in nm  </span>
<span class="sd">    scale: float, optional  </span>
<span class="sd">            factor of increase in the PSF sampling rate relative to the Nyquist</span>
<span class="sd">            limit. default is 1 (Nyquist rate).  </span>
<span class="sd">    out: string, optional</span>
<span class="sd">            Name of output file. If set, the output PSFs will be written to </span>
<span class="sd">            a FITS file as a &quot;data cube&quot;, i.e. the PSFs will be stacked in an</span>
<span class="sd">            3D array.  </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    psf_array: ndarray  </span>
<span class="sd">            PSFs stacked in a 3D Numpy array.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing PSFs for wavelength = </span><span class="si">%s</span><span class="s2"> nm&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale must be &gt;= 1&quot;</span><span class="p">)</span>
    <span class="n">psf_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">otf_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">otf</span><span class="p">(</span><span class="n">objectlist</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">otf</span> <span class="ow">in</span> <span class="n">otf_array</span><span class="p">:</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resample</span><span class="p">(</span><span class="n">otf</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="n">psf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
    <span class="n">psf_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span> <span class="ow">or</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s2">&quot;.FITS&quot;</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">psf_array</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;pscale&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n2</span><span class="p">)),</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;arcsec per pixel&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving PSFs in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;File must be of FITS format&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error ocurred while writing to file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">psf_array</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Reconstruct.strut_functions">
    <p>def <span class="ident">strut_functions</span>(</p><p>self, objpos, dlgs=None, dngs=None, dfit=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute structure functions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Reconstruct.strut_functions', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Reconstruct.strut_functions" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">strut_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">dlgs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dngs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dfit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute structure functions&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dlgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dlgs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dlgs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dngs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dngs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dngs</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">objpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dfit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dfit</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfitting</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.Structure" class="name">class <span class="ident">Structure</span></p>
      
  
    <div class="desc"><p>Muse GLAO structure functions
Includes the effects of anisoplanetism and fitting errors only</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Structure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Muse GLAO structure functions</span>
<span class="sd">    Includes the effects of anisoplanetism and fitting errors only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Structure function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        aoname: string  </span>
<span class="sd">            name of the AO correction system  </span>
<span class="sd">        atmosphere: object  </span>
<span class="sd">            Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">        pixdiam: int  </span>
<span class="sd">            Diameter of the telescope pupil in pixels.  </span>
<span class="sd">        integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">            integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">        debug: bool  </span>
<span class="sd">            If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span> <span class="o">=</span> <span class="n">aoname</span>
        <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="n">_lgspos</span><span class="p">,</span> <span class="n">_hlgs</span><span class="p">,</span> <span class="n">_n_zernike</span><span class="p">,</span> <span class="n">_pupil_diameter</span> <span class="o">=</span> <span class="n">ao_systems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">_lgspos</span>
        <span class="sd">&quot;&quot;&quot;List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span> <span class="o">=</span> <span class="n">_hlgs</span>
        <span class="sd">&quot;&quot;&quot;Height of the LGSs (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">=</span> <span class="n">_n_zernike</span>
        <span class="sd">&quot;&quot;&quot;Number of Zernike modes corrected by the AO system. Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">=</span> <span class="n">_pupil_diameter</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the telescope mirror (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">cn2_profile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Normalized Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of atmospheric layers&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">atmosphere</span><span class="o">.</span><span class="n">outer_scale</span>
        <span class="sd">&quot;&quot;&quot;Value of the outer scale (in m). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">Zernike</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Zernike polynomial instance&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>  <span class="c1">#must be integer</span>
        <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
        <span class="n">_rho</span><span class="p">,</span> <span class="n">_phi</span><span class="p">,</span> <span class="n">_mask</span> <span class="o">=</span> <span class="n">polar2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">fourpixels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">_rho</span>
        <span class="sd">&quot;&quot;&quot;Grid of rho polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">_phi</span>
        <span class="sd">&quot;&quot;&quot;Grid of phi polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">_mask</span>
        <span class="sd">&quot;&quot;&quot;Pupil function. Value is one inside the pupil and zero outside.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">&gt;</span> <span class="mi">980</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_compmask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_zcoef_mask</span>

    <span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert cartesian coordinates to polar for the object</span>
<span class="sd">        and the GSs absolute and relative positions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
        <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
        <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
        <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
        <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
            <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                    <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>

    <span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
        <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
        <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
        <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
                <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
        <span class="k">return</span> <span class="n">final_integral</span>

    <span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
        <span class="c1">#with svd</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#with eigen vectors</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>

    <span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
            <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
        <span class="k">return</span> <span class="n">u</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.Structure">Structure</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.Zernike" class="name">var <span class="ident">Zernike</span></p>
            

            
  
    <div class="desc"><p>Zernike polynomial instance</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.aoname" class="name">var <span class="ident">aoname</span></p>
            

            
  
    <div class="desc"><p>String with the name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.cn2" class="name">var <span class="ident">cn2</span></p>
            

            
  
    <div class="desc"><p>Normalized Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.h_profile" class="name">var <span class="ident">h_profile</span></p>
            

            
  
    <div class="desc"><p>Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.hlgs" class="name">var <span class="ident">hlgs</span></p>
            

            
  
    <div class="desc"><p>Height of the LGSs (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.integrator" class="name">var <span class="ident">integrator</span></p>
            

            
  
    <div class="desc"><p>Integrator used to conpute correlations between Zernike coefficients.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.lgspos" class="name">var <span class="ident">lgspos</span></p>
            

            
  
    <div class="desc"><p>List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.mask" class="name">var <span class="ident">mask</span></p>
            

            
  
    <div class="desc"><p>Pupil function. Value is one inside the pupil and zero outside.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.n_layers" class="name">var <span class="ident">n_layers</span></p>
            

            
  
    <div class="desc"><p>Number of atmospheric layers</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.n_zernike" class="name">var <span class="ident">n_zernike</span></p>
            

            
  
    <div class="desc"><p>Number of Zernike modes corrected by the AO system. Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.outer_scale" class="name">var <span class="ident">outer_scale</span></p>
            

            
  
    <div class="desc"><p>Value of the outer scale (in m). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.phi" class="name">var <span class="ident">phi</span></p>
            

            
  
    <div class="desc"><p>Grid of phi polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.pixdiam" class="name">var <span class="ident">pixdiam</span></p>
            

            
  
    <div class="desc"><p>Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.pupil_diameter" class="name">var <span class="ident">pupil_diameter</span></p>
            

            
  
    <div class="desc"><p>Diameter of the telescope mirror (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.Structure.rho" class="name">var <span class="ident">rho</span></p>
            

            
  
    <div class="desc"><p>Grid of rho polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Structure.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, aoname, atmosphere, pixdiam, integrator, debug)</p>
    </div>
    

    
  
    <div class="desc"><p>Structure function</p>
<h2>Parameters</h2>
<p>aoname: string<br />
    name of the AO correction system<br />
atmosphere: object<br />
    Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class. Contains variables related to the atmosphere.<br />
pixdiam: int<br />
    Diameter of the telescope pupil in pixels.<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
debug: bool<br />
    If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure function</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aoname: string  </span>
<span class="sd">        name of the AO correction system  </span>
<span class="sd">    atmosphere: object  </span>
<span class="sd">        Instance of `rpsfpy.rpsf.Atmosphere` class. Contains variables related to the atmosphere.  </span>
<span class="sd">    pixdiam: int  </span>
<span class="sd">        Diameter of the telescope pupil in pixels.  </span>
<span class="sd">    integrator: &#39;accurate&#39; or &#39;quick&#39;  </span>
<span class="sd">        integrator used to conpute correlations between Zernike coefficients. Default is &#39;accurate&#39;  </span>
<span class="sd">    debug: bool  </span>
<span class="sd">        If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span> <span class="o">=</span> <span class="n">aoname</span>
    <span class="sd">&quot;&quot;&quot;String with the name of the AO correction system: must be a key of the `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
    <span class="n">_lgspos</span><span class="p">,</span> <span class="n">_hlgs</span><span class="p">,</span> <span class="n">_n_zernike</span><span class="p">,</span> <span class="n">_pupil_diameter</span> <span class="o">=</span> <span class="n">ao_systems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">_lgspos</span>
    <span class="sd">&quot;&quot;&quot;List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span> <span class="o">=</span> <span class="n">_hlgs</span>
    <span class="sd">&quot;&quot;&quot;Height of the LGSs (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">=</span> <span class="n">_n_zernike</span>
    <span class="sd">&quot;&quot;&quot;Number of Zernike modes corrected by the AO system. Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">=</span> <span class="n">_pupil_diameter</span>
    <span class="sd">&quot;&quot;&quot;Diameter of the telescope mirror (in m). Read from `rpsfpy.rpsf.AOsystem.systems` dictionary.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">cn2_profile</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Normalized Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Number of atmospheric layers&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span> <span class="o">=</span> <span class="n">atmosphere</span><span class="o">.</span><span class="n">outer_scale</span>
    <span class="sd">&quot;&quot;&quot;Value of the outer scale (in m). Read from  an `rpsfpy.rpsf.Atmosphere` instance.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">Zernike</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Zernike polynomial instance&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pixdiam</span><span class="p">)</span>  <span class="c1">#must be integer</span>
    <span class="sd">&quot;&quot;&quot;Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
    <span class="sd">&quot;&quot;&quot;Integrator used to conpute correlations between Zernike coefficients.&quot;&quot;&quot;</span>
    <span class="n">_rho</span><span class="p">,</span> <span class="n">_phi</span><span class="p">,</span> <span class="n">_mask</span> <span class="o">=</span> <span class="n">polar2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">fourpixels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">_rho</span>
    <span class="sd">&quot;&quot;&quot;Grid of rho polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">_phi</span>
    <span class="sd">&quot;&quot;&quot;Grid of phi polar coordinates in the pupil plane.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">_mask</span>
    <span class="sd">&quot;&quot;&quot;Pupil function. Value is one inside the pupil and zero outside.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span> <span class="o">&gt;</span> <span class="mi">980</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_compmask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span> <span class="o">=</span> <span class="n">_zcoef_mask</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Structure.cart2polar">
    <p>def <span class="ident">cart2polar</span>(</p><p>self, objpos, gspos)</p>
    </div>
    

    
  
    <div class="desc"><p>Convert cartesian coordinates to polar for the object
and the GSs absolute and relative positions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure.cart2polar', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure.cart2polar" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian coordinates to polar for the object</span>
<span class="sd">    and the GSs absolute and relative positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
    <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
    <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
    <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
    <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
        <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
        <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Structure.compvii">
    <p>def <span class="ident">compvii</span>(</p><p>self, z, pupil)</p>
    </div>
    

    
  
    <div class="desc"><p>Computation of the Vii correlation matrix.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure.compvii', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure.compvii" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
        <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
    <span class="k">return</span> <span class="n">u</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Structure.correl_swsw">
    <p>def <span class="ident">correl_swsw</span>(</p><p>self, angle, nz1, nz2, h1, h2, method=&#39;quad&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Correlation coeficients between two spherical waves. This is the 'quick' integrator.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure.correl_swsw', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure.correl_swsw" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
    <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
    <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
    <span class="k">return</span> <span class="n">final_integral</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.Structure.diagcoef">
    <p>def <span class="ident">diagcoef</span>(</p><p>self, M, type=&#39;svd&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Diagonalize coeficient matrices, returns eigen values and vectors.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.Structure.diagcoef', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.Structure.diagcoef" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
    <span class="c1">#with svd</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#with eigen vectors</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.StructureFit" class="name">class <span class="ident">StructureFit</span></p>
      
  
    <div class="desc"><p>Fitting error structure function</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StructureFit</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitting error structure function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureFit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;Fitting error structure function&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphifit.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Fitting error structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_computefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc_constant</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fitting error structure function&quot;&quot;&quot;</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">polar2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">])</span>
        <span class="n">radial</span><span class="p">,</span> <span class="n">azi</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span>
        <span class="n">tot_correletion_aiaj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">Fc</span> <span class="o">=</span> <span class="n">fc_constant</span> <span class="o">*</span> <span class="p">(</span><span class="n">radial</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">):</span>
                <span class="n">lower_bound</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="p">)),</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="mf">150.</span><span class="p">)</span>
                <span class="n">tot_correletion_aiaj</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.023</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="mf">11.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">tot_correletion_aiaj</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc_constant</span><span class="o">=</span><span class="mf">0.37</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute fitting error structure function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fc_constant: float  </span>
<span class="sd">             constant used in the approximation to the structure function  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphifit: numpy array  </span>
<span class="sd">            fitting error structure function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Fitting error structure function.&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computefit</span><span class="p">(</span><span class="n">fc_constant</span><span class="p">)</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">dfit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">dfit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_FIT&quot;</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving Fitting error structure function in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.StructureFit">StructureFit</a></li>
          <li><a href="#rpsfpy.rpsf.Structure">Structure</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.Zernike" class="name">var <span class="ident">Zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.Zernike">Zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Zernike polynomial instance</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.aoname" class="name">var <span class="ident">aoname</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.aoname">aoname</a></code>
    </p>

            
  
    <div class="desc inherited"><p>String with the name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.cn2" class="name">var <span class="ident">cn2</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cn2">cn2</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Normalized Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.dphifit" class="name">var <span class="ident">dphifit</span></p>
            

            
  
    <div class="desc"><p>Fitting error structure function</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.h_profile" class="name">var <span class="ident">h_profile</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.h_profile">h_profile</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.hlgs" class="name">var <span class="ident">hlgs</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.hlgs">hlgs</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of the LGSs (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.integrator" class="name">var <span class="ident">integrator</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.integrator">integrator</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Integrator used to conpute correlations between Zernike coefficients.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.lgspos" class="name">var <span class="ident">lgspos</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.lgspos">lgspos</a></code>
    </p>

            
  
    <div class="desc inherited"><p>List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.mask" class="name">var <span class="ident">mask</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.mask">mask</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Pupil function. Value is one inside the pupil and zero outside.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.n_layers" class="name">var <span class="ident">n_layers</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_layers">n_layers</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of atmospheric layers</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.n_zernike" class="name">var <span class="ident">n_zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_zernike">n_zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of Zernike modes corrected by the AO system. Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.outer_scale" class="name">var <span class="ident">outer_scale</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.outer_scale">outer_scale</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Value of the outer scale (in m). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.phi" class="name">var <span class="ident">phi</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.phi">phi</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of phi polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.pixdiam" class="name">var <span class="ident">pixdiam</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pixdiam">pixdiam</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.pupil_diameter" class="name">var <span class="ident">pupil_diameter</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pupil_diameter">pupil_diameter</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the telescope mirror (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureFit.rho" class="name">var <span class="ident">rho</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.rho">rho</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of rho polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, aoname, atmosphere, pixdiam, debug=False)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.__init__">__init__</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Structure function</p>
<h2>Parameters</h2>
<p>aoname: string<br />
    name of the AO correction system<br />
atmosphere: object<br />
    Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class. Contains variables related to the atmosphere.<br />
pixdiam: int<br />
    Diameter of the telescope pupil in pixels.<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
debug: bool<br />
    If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StructureFit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Fitting error structure function&quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.cart2polar">
    <p>def <span class="ident">cart2polar</span>(</p><p>self, objpos, gspos)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cart2polar">cart2polar</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Convert cartesian coordinates to polar for the object
and the GSs absolute and relative positions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.cart2polar', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.cart2polar" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian coordinates to polar for the object</span>
<span class="sd">    and the GSs absolute and relative positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
    <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
    <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
    <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
    <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
        <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
        <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.compute">
    <p>def <span class="ident">compute</span>(</p><p>self, fc_constant=0.37)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute fitting error structure function.</p>
<h2>Parameters</h2>
<p>fc_constant: float<br />
     constant used in the approximation to the structure function  </p>
<h2>Returns</h2>
<p>dphifit: numpy array<br />
    fitting error structure function</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.compute', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.compute" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fc_constant</span><span class="o">=</span><span class="mf">0.37</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute fitting error structure function.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fc_constant: float  </span>
<span class="sd">         constant used in the approximation to the structure function  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dphifit: numpy array  </span>
<span class="sd">        fitting error structure function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing Fitting error structure function.&quot;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="s2">&quot;standard&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
    <span class="n">dfit</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_computefit</span><span class="p">(</span><span class="n">fc_constant</span><span class="p">)</span>
        <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">dfit</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">dfit</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_FIT&quot;</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving Fitting error structure function in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.compvii">
    <p>def <span class="ident">compvii</span>(</p><p>self, z, pupil)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.compvii">compvii</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Computation of the Vii correlation matrix.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.compvii', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.compvii" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
        <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
    <span class="k">return</span> <span class="n">u</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.correl_swsw">
    <p>def <span class="ident">correl_swsw</span>(</p><p>self, angle, nz1, nz2, h1, h2, method=&#39;quad&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.correl_swsw">correl_swsw</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Correlation coeficients between two spherical waves. This is the 'quick' integrator.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.correl_swsw', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.correl_swsw" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
    <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
    <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
    <span class="k">return</span> <span class="n">final_integral</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.diagcoef">
    <p>def <span class="ident">diagcoef</span>(</p><p>self, M, type=&#39;svd&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.diagcoef">diagcoef</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Diagonalize coeficient matrices, returns eigen values and vectors.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.diagcoef', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.diagcoef" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
    <span class="c1">#with svd</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#with eigen vectors</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.readfromfile">
    <p>def <span class="ident">readfromfile</span>(</p><p>self, filename)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.readfromfile', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.readfromfile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureFit.save2file">
    <p>def <span class="ident">save2file</span>(</p><p>self, filename=&#39;dphifit.dat&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Save Structure function in ASCII file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureFit.save2file', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureFit.save2file" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphifit.dat&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphifit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Fitting error structure function not available&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.StructureLGS" class="name">class <span class="ident">StructureLGS</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StructureLGS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureLGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of LGSs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
        <span class="sd">&quot;&quot;&quot;Height of natural stars (NGS and science objects). Default value is 10.e20.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span>
        <span class="sd">&quot;&quot;&quot;Relative weight of each LGS. By default all have the same weight.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="sd">&quot;&quot;&quot;Permutations of LGSs indices (e.g. for 4 LGSs: [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)]).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncombilgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Number of LGSs indices permutations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Up to the specified numberof corrected modes, except the piston, tip and tilt.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must chose 1 or more CPUs&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setlgspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lgspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set LGS coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">lgspos</span>

    <span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphilgs.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;LGS structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read structure function from ASCII file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_lgscoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">coefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;quick&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correl_swsw</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;accurate&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chassat</span><span class="o">.</span><span class="n">correl_osos_general</span><span class="p">([</span><span class="n">alpha</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">,</span> <span class="n">dr0</span> <span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">num_zern1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_zern2</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">gd_echelle</span> <span class="o">=</span> <span class="mf">25.</span><span class="p">,</span> <span class="n">borne_min</span> <span class="o">=</span> <span class="mf">7.e-3</span><span class="p">,</span><span class="n">npas</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Integrator must be a choice of &#39;accurate&#39; or &#39;quick&#39; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefmatrix</span><span class="p">,</span> <span class="n">modes</span>

    <span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute covariance matrix of Zernike coefficients</span>

<span class="sd">        The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">        two sources sepparated by alpha at heights h1 and h2</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        h1: float  </span>
<span class="sd">            height of the first source in m  </span>
<span class="sd">        h2: float  </span>
<span class="sd">            height of the first source in m  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        lgscoefmatrix: numpy array  </span>
<span class="sd">            matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
        <span class="c1">#modes = []</span>
        <span class="c1">#for i in np.arange(4,self.n_zernike):</span>
        <span class="c1">#    for j in np.arange(i,self.n_zernike):</span>
        <span class="c1">#        if self.zcoef_mask[j-2,i-2]:</span>
        <span class="c1">#            modes.append((i,j))</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
                <span class="n">start_i</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">step</span>
                <span class="n">end_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">modes_split</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">start_i</span><span class="p">:</span><span class="n">end_i</span><span class="p">]</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_lgscoef</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">modes_split</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)))</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
                <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                    <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lgscoefmatrix</span>

    <span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a term of the LGS structure function corresponding to the</span>
<span class="sd">        correlation between two sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        gamma: float  </span>
<span class="sd">            angle between the vectors defined b the two sources  </span>
<span class="sd">        h1: float  </span>
<span class="sd">            height of the first source in m  </span>
<span class="sd">        h2: float  </span>
<span class="sd">            height of the first source in m  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        structure function term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lgscoefmatrix</span><span class="p">)</span>
        <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">lgscoefmatrix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">lgsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">lgsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">lgsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lgs_term1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute first term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing first term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term1</span>

    <span class="k">def</span> <span class="nf">_lgs_term2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Second term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing second term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_lgs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">):</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">,</span><span class="n">i_lgs</span><span class="p">],</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="p">[</span><span class="n">i_lgs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">term2</span>

    <span class="k">def</span> <span class="nf">_lgs_term3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Third term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing third term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lgs_term4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fourth term of LGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing fourth term of LGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">b_lgs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncombilgs</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="n">term4</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">,</span><span class="n">r_idx</span><span class="p">],</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span><span class="p">[</span><span class="n">b_lgs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term4</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute LGS anisoplanatism structure function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        objpos: list of lists  </span>
<span class="sd">             coordinates of the science obect (posiiton where to compute the PSF) (in arcsec)  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphilgs: numpy array  </span>
<span class="sd">            LGS anisoplanatism structure function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing LGS structure function using </span><span class="si">%s</span><span class="s2"> CPUs.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">data1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term1</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term1</span><span class="p">)</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term2</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term2</span><span class="p">)</span>
        <span class="n">key3</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span> 
        <span class="n">data3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term3</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term3</span><span class="p">)</span>
        <span class="n">key4</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs4&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="n">data4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">term4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term4</span><span class="p">()</span>
            <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.StructureLGS">StructureLGS</a></li>
          <li><a href="#rpsfpy.rpsf.Structure">Structure</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.Zernike" class="name">var <span class="ident">Zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.Zernike">Zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Zernike polynomial instance</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.aoname" class="name">var <span class="ident">aoname</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.aoname">aoname</a></code>
    </p>

            
  
    <div class="desc inherited"><p>String with the name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.cn2" class="name">var <span class="ident">cn2</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cn2">cn2</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Normalized Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.combilgs" class="name">var <span class="ident">combilgs</span></p>
            

            
  
    <div class="desc"><p>Permutations of LGSs indices (e.g. for 4 LGSs: [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)]).</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.dphilgs" class="name">var <span class="ident">dphilgs</span></p>
            

            
  
    <div class="desc"><p>LGS anisoplanatism structure function</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.h_profile" class="name">var <span class="ident">h_profile</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.h_profile">h_profile</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.hlgs" class="name">var <span class="ident">hlgs</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.hlgs">hlgs</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of the LGSs (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.hngs" class="name">var <span class="ident">hngs</span></p>
            

            
  
    <div class="desc"><p>Height of natural stars (NGS and science objects). Default value is 10.e20.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.integrator" class="name">var <span class="ident">integrator</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.integrator">integrator</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Integrator used to conpute correlations between Zernike coefficients.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.lgspos" class="name">var <span class="ident">lgspos</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.lgspos">lgspos</a></code>
    </p>

            
  
    <div class="desc inherited"><p>List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.mask" class="name">var <span class="ident">mask</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.mask">mask</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Pupil function. Value is one inside the pupil and zero outside.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.n_layers" class="name">var <span class="ident">n_layers</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_layers">n_layers</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of atmospheric layers</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.n_zernike" class="name">var <span class="ident">n_zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_zernike">n_zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of Zernike modes corrected by the AO system. Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.ncombilgs" class="name">var <span class="ident">ncombilgs</span></p>
            

            
  
    <div class="desc"><p>Number of LGSs indices permutations.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.nlgs" class="name">var <span class="ident">nlgs</span></p>
            

            
  
    <div class="desc"><p>Number of LGSs.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.outer_scale" class="name">var <span class="ident">outer_scale</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.outer_scale">outer_scale</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Value of the outer scale (in m). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.parallel" class="name">var <span class="ident">parallel</span></p>
            

            
  
    <div class="desc"><p>Number of cores available for the computation of the structure function. Defaults to 'auto': use all available cores.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.phi" class="name">var <span class="ident">phi</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.phi">phi</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of phi polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.pixdiam" class="name">var <span class="ident">pixdiam</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pixdiam">pixdiam</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.pupil_diameter" class="name">var <span class="ident">pupil_diameter</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pupil_diameter">pupil_diameter</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the telescope mirror (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.rho" class="name">var <span class="ident">rho</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.rho">rho</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of rho polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.sigmaslgs" class="name">var <span class="ident">sigmaslgs</span></p>
            

            
  
    <div class="desc"><p>Relative weight of each LGS. By default all have the same weight.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureLGS.zernikes" class="name">var <span class="ident">zernikes</span></p>
            

            
  
    <div class="desc"><p>Array of Zernike polinomyals. Up to the specified numberof corrected modes, except the piston, tip and tilt.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, aoname, atmosphere, pixdiam, integrator, parallel=&#39;auto&#39;, hngs=1e+21, debug=False)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.__init__">__init__</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Structure function</p>
<h2>Parameters</h2>
<p>aoname: string<br />
    name of the AO correction system<br />
atmosphere: object<br />
    Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class. Contains variables related to the atmosphere.<br />
pixdiam: int<br />
    Diameter of the telescope pupil in pixels.<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
debug: bool<br />
    If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StructureLGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Number of LGSs.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
    <span class="sd">&quot;&quot;&quot;Height of natural stars (NGS and science objects). Default value is 10.e20.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaslgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span>
    <span class="sd">&quot;&quot;&quot;Relative weight of each LGS. By default all have the same weight.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlgs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="sd">&quot;&quot;&quot;Permutations of LGSs indices (e.g. for 4 LGSs: [(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)]).&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ncombilgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Number of LGSs indices permutations.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Up to the specified numberof corrected modes, except the piston, tip and tilt.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
    <span class="sd">&quot;&quot;&quot;Number of cores available for the computation of the structure function. Defaults to &#39;auto&#39;: use all available cores.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must chose 1 or more CPUs&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.cart2polar">
    <p>def <span class="ident">cart2polar</span>(</p><p>self, objpos, gspos)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cart2polar">cart2polar</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Convert cartesian coordinates to polar for the object
and the GSs absolute and relative positions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.cart2polar', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.cart2polar" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian coordinates to polar for the object</span>
<span class="sd">    and the GSs absolute and relative positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
    <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
    <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
    <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
    <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
        <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
        <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.compute">
    <p>def <span class="ident">compute</span>(</p><p>self, objpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute LGS anisoplanatism structure function</p>
<h2>Parameters</h2>
<p>objpos: list of lists<br />
     coordinates of the science obect (posiiton where to compute the PSF) (in arcsec)  </p>
<h2>Returns</h2>
<p>dphilgs: numpy array<br />
    LGS anisoplanatism structure function</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.compute', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.compute" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute LGS anisoplanatism structure function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objpos: list of lists  </span>
<span class="sd">         coordinates of the science obect (posiiton where to compute the PSF) (in arcsec)  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dphilgs: numpy array  </span>
<span class="sd">        LGS anisoplanatism structure function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing LGS structure function using </span><span class="si">%s</span><span class="s2"> CPUs.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span><span class="p">)</span>
    <span class="n">key1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="n">data1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term1</span><span class="p">()</span>
        <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key1</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term1</span><span class="p">)</span>
    <span class="n">key2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">data2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term2</span><span class="p">()</span>
        <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key2</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data2</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term2</span><span class="p">)</span>
    <span class="n">key3</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
    <span class="n">data3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span> 
    <span class="n">data3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
    <span class="n">term3</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term3</span><span class="p">()</span>
        <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key3</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data3</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term3</span><span class="p">)</span>
    <span class="n">key4</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lgs4&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
    <span class="n">data4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alphalgs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combilgs</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">betalgs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">data4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span><span class="p">)</span>
    <span class="n">term4</span> <span class="o">=</span> <span class="n">pclib</span><span class="o">.</span><span class="n">getfunction</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lgs_term4</span><span class="p">()</span>
        <span class="n">pclib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_key</span><span class="o">=</span><span class="n">key4</span><span class="p">,</span> <span class="n">data_values</span><span class="o">=</span><span class="n">data4</span><span class="p">,</span> <span class="n">structure_function</span><span class="o">=</span><span class="n">term4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.compute_term">
    <p>def <span class="ident">compute_term</span>(</p><p>self, alpha, gamma, h1, h2)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute a term of the LGS structure function corresponding to the
correlation between two sources.</p>
<h2>Parameters</h2>
<p>alpha: float<br />
    distance between the two sources in arcsec<br />
gamma: float<br />
    angle between the vectors defined b the two sources<br />
h1: float<br />
    height of the first source in m<br />
h2: float<br />
    height of the first source in m  </p>
<h2>Returns</h2>
<p>structure function term</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.compute_term', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.compute_term" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a term of the LGS structure function corresponding to the</span>
<span class="sd">    correlation between two sources.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha: float  </span>
<span class="sd">        distance between the two sources in arcsec  </span>
<span class="sd">    gamma: float  </span>
<span class="sd">        angle between the vectors defined b the two sources  </span>
<span class="sd">    h1: float  </span>
<span class="sd">        height of the first source in m  </span>
<span class="sd">    h2: float  </span>
<span class="sd">        height of the first source in m  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structure function term</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;_LGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving LGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lgscoefmatrix</span><span class="p">)</span>
    <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">lgscoefmatrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
    <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="n">lgsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">lgsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">lgsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.compvii">
    <p>def <span class="ident">compvii</span>(</p><p>self, z, pupil)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.compvii">compvii</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Computation of the Vii correlation matrix.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.compvii', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.compvii" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
        <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
    <span class="k">return</span> <span class="n">u</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.correl_swsw">
    <p>def <span class="ident">correl_swsw</span>(</p><p>self, angle, nz1, nz2, h1, h2, method=&#39;quad&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.correl_swsw">correl_swsw</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Correlation coeficients between two spherical waves. This is the 'quick' integrator.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.correl_swsw', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.correl_swsw" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
    <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
    <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
    <span class="k">return</span> <span class="n">final_integral</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.cov_zernike">
    <p>def <span class="ident">cov_zernike</span>(</p><p>self, alpha, h1, h2)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute covariance matrix of Zernike coefficients</p>
<p>The Zernike coefficients are from the expansions in Zernike basis of 
two sources sepparated by alpha at heights h1 and h2</p>
<h2>Parameters</h2>
<p>alpha: float<br />
    distance between the two sources in arcsec<br />
h1: float<br />
    height of the first source in m<br />
h2: float<br />
    height of the first source in m  </p>
<h2>Returns</h2>
<p>lgscoefmatrix: numpy array<br />
    matrix of correlations between Zernike coefficients i and j</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.cov_zernike', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.cov_zernike" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute covariance matrix of Zernike coefficients</span>
<span class="sd">    The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">    two sources sepparated by alpha at heights h1 and h2</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha: float  </span>
<span class="sd">        distance between the two sources in arcsec  </span>
<span class="sd">    h1: float  </span>
<span class="sd">        height of the first source in m  </span>
<span class="sd">    h2: float  </span>
<span class="sd">        height of the first source in m  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lgscoefmatrix: numpy array  </span>
<span class="sd">        matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lgscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">lgsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zcoef_mask</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
    <span class="c1">#modes = []</span>
    <span class="c1">#for i in np.arange(4,self.n_zernike):</span>
    <span class="c1">#    for j in np.arange(i,self.n_zernike):</span>
    <span class="c1">#        if self.zcoef_mask[j-2,i-2]:</span>
    <span class="c1">#            modes.append((i,j))</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
            <span class="n">start_i</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">step</span>
            <span class="n">end_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">modes_split</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">start_i</span><span class="p">:</span><span class="n">end_i</span><span class="p">]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_lgscoef</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">modes_split</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
            <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span>
                <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_zernike</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lgscoefmatrix</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.diagcoef">
    <p>def <span class="ident">diagcoef</span>(</p><p>self, M, type=&#39;svd&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.diagcoef">diagcoef</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Diagonalize coeficient matrices, returns eigen values and vectors.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.diagcoef', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.diagcoef" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
    <span class="c1">#with svd</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#with eigen vectors</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.readfromfile">
    <p>def <span class="ident">readfromfile</span>(</p><p>self, filename)</p>
    </div>
    

    
  
    <div class="desc"><p>Read structure function from ASCII file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.readfromfile', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.readfromfile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read structure function from ASCII file&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.save2file">
    <p>def <span class="ident">save2file</span>(</p><p>self, filename=&#39;dphilgs.dat&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Save Structure function in ASCII file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.save2file', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.save2file" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphilgs.dat&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphilgs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;LGS structure function not available&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.setlgspos">
    <p>def <span class="ident">setlgspos</span>(</p><p>self, lgspos)</p>
    </div>
    

    
  
    <div class="desc"><p>Set LGS coordinates</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.setlgspos', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.setlgspos" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">setlgspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lgspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set LGS coordinates&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lgspos</span> <span class="o">=</span> <span class="n">lgspos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureLGS.setobjpos">
    <p>def <span class="ident">setobjpos</span>(</p><p>self, objpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Set Object coordinates</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureLGS.setobjpos', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureLGS.setobjpos" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="rpsfpy.rpsf.StructureNGS" class="name">class <span class="ident">StructureNGS</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StructureNGS</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructureNGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
        <span class="sd">&quot;&quot;&quot;Height of the NGS in m. Deafult is 10.e20.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Tip and tilt only.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setngspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set NGS coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>

    <span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>

    <span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphings.dat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;NGS structure function not available&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_ngscoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">coefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_modes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;quick&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correl_swsw</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">==</span> <span class="s2">&quot;accurate&quot;</span><span class="p">:</span>
                <span class="n">coefmatrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chassat</span><span class="o">.</span><span class="n">correl_osos_general</span><span class="p">([</span><span class="n">alpha</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">,</span> <span class="n">dr0</span> <span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">num_zern1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_zern2</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">gd_echelle</span> <span class="o">=</span> <span class="mf">25.</span><span class="p">,</span> <span class="n">borne_min</span> <span class="o">=</span> <span class="mf">7.e-3</span><span class="p">,</span><span class="n">npas</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Integrator must be a choice of &#39;accurate&#39; or &#39;quick&#39; &quot;</span><span class="p">)</span>
            <span class="c1">#coefmatrix[idx] = self.correl_swsw(alpha, i, j, self.hngs, self.hngs)</span>
            <span class="c1">#coefmatrix[idx] = chassat.correl_osos_general([alpha], self.pupil_diameter, self.hngs, self.hngs, self.cn2, self.h_profile, dr0 =1., num_zern1 = i, num_zern2 = j, gd_echelle = 25., borne_min = 7.e-3,npas = 100)</span>
        <span class="k">return</span> <span class="n">coefmatrix</span><span class="p">,</span> <span class="n">modes</span>

    <span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute covariance matrix of Zernike coefficients</span>

<span class="sd">        The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">        two sources sepparated by alpha at NGS height</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ngscoefmatrix: numpy array  </span>
<span class="sd">            matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ngscoef</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ngscoefmatrix</span>

    <span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a term of the NGS structure function corresponding to the</span>
<span class="sd">        correlation between two sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha: float  </span>
<span class="sd">            distance between the two sources in arcsec  </span>
<span class="sd">        gamma: float  </span>
<span class="sd">            angle between the vectors defined b the two sources  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        structure function term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;NGS&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ngscoefmatrix</span><span class="p">)</span>
        <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">ngscoefmatrix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="n">ngsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">ngsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">ngsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ngs_term1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute first term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing first term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term1</span>

    <span class="k">def</span> <span class="nf">_ngs_term2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Second term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing second term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i_ngs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">):</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">,</span><span class="n">i_ngs</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">gammangs</span><span class="p">[</span><span class="n">i_ngs</span><span class="p">])</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">term2</span>

    <span class="k">def</span> <span class="nf">_ngs_term3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Third term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing third term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ngs_term4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute Fourth term of NGS structure function&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing fourth term of NGS structure function.&quot;</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">b_ngs</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncombings</span><span class="p">):</span>
            <span class="n">l_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">term4</span> <span class="o">=</span> <span class="n">term4</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">,</span><span class="n">r_idx</span><span class="p">],</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">betangs</span><span class="p">[</span><span class="n">b_ngs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">term4</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute NGS anisoplanatism structure function</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        objpos: list of lists  </span>
<span class="sd">             coordinates of the science obect (posiiton where to compute the PSF)  </span>
<span class="sd">        ngspos: list of lists  </span>
<span class="sd">            coordinates of the NGS(s) (in arcsec)  </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        dphings: numpy array  </span>
<span class="sd">            NGS anisoplanatism structure function  </span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        hngs = 10.e20 #try later with infinite</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing NGS structure function.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ngs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncombings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betangs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term1</span><span class="p">()</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term2</span><span class="p">()</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term3</span><span class="p">()</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_NGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_ngs_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2"> and NGS at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#rpsfpy.rpsf.StructureNGS">StructureNGS</a></li>
          <li><a href="#rpsfpy.rpsf.Structure">Structure</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.Zernike" class="name">var <span class="ident">Zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.Zernike">Zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Zernike polynomial instance</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.aoname" class="name">var <span class="ident">aoname</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.aoname">aoname</a></code>
    </p>

            
  
    <div class="desc inherited"><p>String with the name of the AO correction system: must be a key of the <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.cn2" class="name">var <span class="ident">cn2</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cn2">cn2</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Normalized Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.dphings" class="name">var <span class="ident">dphings</span></p>
            

            
  
    <div class="desc"><p>LGS anisoplanatism structure function</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.h_profile" class="name">var <span class="ident">h_profile</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.h_profile">h_profile</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of atmospheric layers corresponding to the Cn2 profile (list). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.hlgs" class="name">var <span class="ident">hlgs</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.hlgs">hlgs</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Height of the LGSs (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.hngs" class="name">var <span class="ident">hngs</span></p>
            

            
  
    <div class="desc"><p>Height of the NGS in m. Deafult is 10.e20.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.integrator" class="name">var <span class="ident">integrator</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.integrator">integrator</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Integrator used to conpute correlations between Zernike coefficients.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.lgspos" class="name">var <span class="ident">lgspos</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.lgspos">lgspos</a></code>
    </p>

            
  
    <div class="desc inherited"><p>List of coordinates (XY) of the LGSs in the FoV (in arcsec). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.mask" class="name">var <span class="ident">mask</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.mask">mask</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Pupil function. Value is one inside the pupil and zero outside.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.n_layers" class="name">var <span class="ident">n_layers</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_layers">n_layers</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of atmospheric layers</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.n_zernike" class="name">var <span class="ident">n_zernike</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.n_zernike">n_zernike</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Number of Zernike modes corrected by the AO system. Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.outer_scale" class="name">var <span class="ident">outer_scale</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.outer_scale">outer_scale</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Value of the outer scale (in m). Read from  an <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> instance.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.phi" class="name">var <span class="ident">phi</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.phi">phi</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of phi polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.pixdiam" class="name">var <span class="ident">pixdiam</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pixdiam">pixdiam</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the pupil in pixels. Note that the sampling is always done at the Nyquist rate.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.pupil_diameter" class="name">var <span class="ident">pupil_diameter</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.pupil_diameter">pupil_diameter</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Diameter of the telescope mirror (in m). Read from <a href="#rpsfpy.rpsf.AOsystem.systems"><code>systems</code></a> dictionary.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.rho" class="name">var <span class="ident">rho</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.rho">rho</a></code>
    </p>

            
  
    <div class="desc inherited"><p>Grid of rho polar coordinates in the pupil plane.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="rpsfpy.rpsf.StructureNGS.zernikes" class="name">var <span class="ident">zernikes</span></p>
            

            
  
    <div class="desc"><p>Array of Zernike polinomyals. Tip and tilt only.</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, aoname, atmosphere, pixdiam, integrator, hngs=1e+21, debug=False)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.__init__">__init__</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Structure function</p>
<h2>Parameters</h2>
<p>aoname: string<br />
    name of the AO correction system<br />
atmosphere: object<br />
    Instance of <a href="#rpsfpy.rpsf.Atmosphere"><code>Atmosphere</code></a> class. Contains variables related to the atmosphere.<br />
pixdiam: int<br />
    Diameter of the telescope pupil in pixels.<br />
integrator: 'accurate' or 'quick'<br />
    integrator used to conpute correlations between Zernike coefficients. Default is 'accurate'<br />
debug: bool<br />
    If true the matrices of correlations between Zernike coefficients will be aved in ASCII files. Default is False</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.__init__', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">hngs</span><span class="o">=</span><span class="mf">10.e20</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StructureNGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aoname</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">pixdiam</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hngs</span> <span class="o">=</span> <span class="n">hngs</span>
    <span class="sd">&quot;&quot;&quot;Height of the NGS in m. Deafult is 10.e20.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;LGS anisoplanatism structure function&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;Array of Zernike polinomyals. Tip and tilt only.&quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.cart2polar">
    <p>def <span class="ident">cart2polar</span>(</p><p>self, objpos, gspos)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.cart2polar">cart2polar</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Convert cartesian coordinates to polar for the object
and the GSs absolute and relative positions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.cart2polar', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.cart2polar" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">gspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian coordinates to polar for the object</span>
<span class="sd">    and the GSs absolute and relative positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span>
    <span class="n">combi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="n">ncombi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combi</span><span class="p">)</span>
    <span class="n">xob</span><span class="p">,</span> <span class="n">yob</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="n">xgs</span><span class="p">,</span> <span class="n">ygs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gspos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">alphags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngs</span><span class="p">,</span><span class="n">ngs</span><span class="p">))</span>
    <span class="n">gammags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngs</span><span class="p">)</span>
    <span class="n">betags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncombi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncombi</span><span class="p">):</span>
        <span class="n">l_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_idx</span> <span class="o">=</span> <span class="n">combi</span><span class="p">[</span><span class="n">b_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">betags</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">ygs</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngs</span><span class="p">):</span>
        <span class="n">gammags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_angletiti</span><span class="p">(</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">,</span> <span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ngs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yob</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">ygs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ygs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">alphags</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alphags</span><span class="p">,</span> <span class="n">gammags</span><span class="p">,</span> <span class="n">betags</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.compute">
    <p>def <span class="ident">compute</span>(</p><p>self, objpos, ngspos)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute NGS anisoplanatism structure function</p>
<h2>Parameters</h2>
<p>objpos: list of lists<br />
     coordinates of the science obect (posiiton where to compute the PSF)<br />
ngspos: list of lists<br />
    coordinates of the NGS(s) (in arcsec)  </p>
<h2>Returns</h2>
<p>dphings: numpy array<br />
    NGS anisoplanatism structure function</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.compute', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.compute" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute NGS anisoplanatism structure function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objpos: list of lists  </span>
<span class="sd">         coordinates of the science obect (posiiton where to compute the PSF)  </span>
<span class="sd">    ngspos: list of lists  </span>
<span class="sd">        coordinates of the NGS(s) (in arcsec)  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dphings: numpy array  </span>
<span class="sd">        NGS anisoplanatism structure function  </span>
<span class="sd">    &quot;&quot;&quot;</span>
     <span class="n">hngs</span> <span class="o">=</span> <span class="mf">10.e20</span> <span class="c1">#try later with infinite</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing NGS structure function.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ngs positions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmasngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nngs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">combings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nngs</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="s1">&#39;i, i&#39;</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ncombings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combings</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alphangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammangs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betangs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart2polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term1</span><span class="p">()</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term2</span><span class="p">()</span>
    <span class="n">term3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term3</span><span class="p">()</span>
    <span class="n">term4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngs_term4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">term4</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span> <span class="o">+</span> <span class="s2">&quot;_NGS_&quot;</span> <span class="o">+</span> <span class="s2">&quot;object_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_ngs_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS structure function in file </span><span class="si">%s</span><span class="s2">, for sources at </span><span class="si">%s</span><span class="s2"> and NGS at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.compute_term">
    <p>def <span class="ident">compute_term</span>(</p><p>self, alpha, gamma)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute a term of the NGS structure function corresponding to the
correlation between two sources.</p>
<h2>Parameters</h2>
<p>alpha: float<br />
    distance between the two sources in arcsec<br />
gamma: float<br />
    angle between the vectors defined b the two sources  </p>
<h2>Returns</h2>
<p>structure function term</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.compute_term', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.compute_term" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a term of the NGS structure function corresponding to the</span>
<span class="sd">    correlation between two sources.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha: float  </span>
<span class="sd">        distance between the two sources in arcsec  </span>
<span class="sd">    gamma: float  </span>
<span class="sd">        angle between the vectors defined b the two sources  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structure function term</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_zernike</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;coefmatrix&quot;</span> <span class="o">+</span> <span class="s2">&quot;NGS&quot;</span> <span class="o">+</span> <span class="s2">&quot;alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_gamma_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_h2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hngs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;DEBUG flag set: saving NGS covariance matrix in file </span><span class="si">%s</span><span class="s2">, for sources sepparated by </span><span class="si">%s</span><span class="s2">, at heights </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ngscoefmatrix</span><span class="p">)</span>
    <span class="n">propervalues</span><span class="p">,</span> <span class="n">propervectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagcoef</span><span class="p">(</span><span class="n">ngscoefmatrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Zernike</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
    <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">propervectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zernikes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="n">ngsvmatrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compvii</span><span class="p">(</span><span class="n">ngsnewzernikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">propervalues</span><span class="p">,</span> <span class="n">ngsvmatrices</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.compvii">
    <p>def <span class="ident">compvii</span>(</p><p>self, z, pupil)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.compvii">compvii</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Computation of the Vii correlation matrix.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.compvii', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.compvii" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compvii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pupil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computation of the Vii correlation matrix.&quot;&quot;&quot;</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftcorr</span><span class="p">(</span><span class="n">pupil</span><span class="p">,</span><span class="n">pupil</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrPP</span><span class="o">&gt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">corrPP</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">corrPP</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">corrPP</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
        <span class="n">corij</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">corzw</span> <span class="o">=</span> <span class="n">fftcorr</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">pupil</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">imshape</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">corzw</span> <span class="o">-</span> <span class="n">corij</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">corrPP</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
    <span class="k">return</span> <span class="n">u</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.correl_swsw">
    <p>def <span class="ident">correl_swsw</span>(</p><p>self, angle, nz1, nz2, h1, h2, method=&#39;quad&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.correl_swsw">correl_swsw</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Correlation coeficients between two spherical waves. This is the 'quick' integrator.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.correl_swsw', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.correl_swsw" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">correl_swsw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Correlation coeficients between two spherical waves. This is the &#39;quick&#39; integrator.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">4.85</span><span class="o">*</span><span class="mf">1.e-6</span>
    <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pupil_diameter</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">R</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">/</span> <span class="n">R1</span>
    <span class="n">Lam</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_scale</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz1</span><span class="p">)</span>
    <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">zernike</span><span class="o">.</span><span class="n">noll2zern</span><span class="p">(</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="n">_kvalues</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">nz2</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_chassat_integral</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>  <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
            <span class="n">result_quad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">_modified_chassat</span><span class="p">,</span> <span class="mf">1.e-26</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">zeta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Lam</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">),</span> <span class="n">vec_func</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_quad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">R1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">results</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_integral</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span> <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn2</span> <span class="o">*</span> <span class="n">R1</span><span class="o">**</span><span class="p">(</span><span class="mf">5.</span><span class="o">/</span><span class="mf">3.</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h_profile</span><span class="p">)</span>
    <span class="n">final_integral</span> <span class="o">=</span> <span class="mf">3.895</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="n">n2</span><span class="o">-</span><span class="n">m1</span><span class="o">-</span><span class="n">m2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n1</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="n">final_integral</span>
    <span class="k">return</span> <span class="n">final_integral</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.cov_zernike">
    <p>def <span class="ident">cov_zernike</span>(</p><p>self, alpha)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute covariance matrix of Zernike coefficients</p>
<p>The Zernike coefficients are from the expansions in Zernike basis of 
two sources sepparated by alpha at NGS height</p>
<h2>Parameters</h2>
<p>alpha: float<br />
    distance between the two sources in arcsec  </p>
<h2>Returns</h2>
<p>ngscoefmatrix: numpy array<br />
    matrix of correlations between Zernike coefficients i and j</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.cov_zernike', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.cov_zernike" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">cov_zernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute covariance matrix of Zernike coefficients</span>
<span class="sd">    The Zernike coefficients are from the expansions in Zernike basis of </span>
<span class="sd">    two sources sepparated by alpha at NGS height</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha: float  </span>
<span class="sd">        distance between the two sources in arcsec  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ngscoefmatrix: numpy array  </span>
<span class="sd">        matrix of correlations between Zernike coefficients i and j  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
    <span class="n">ngscoefmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">ngsnewzernikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixdiam</span><span class="p">))</span>
    <span class="n">values_received</span><span class="p">,</span> <span class="n">modes_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ngscoef</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes_received</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">modes_received</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_received</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngscoefmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ngscoefmatrix</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.diagcoef">
    <p>def <span class="ident">diagcoef</span>(</p><p>self, M, type=&#39;svd&#39;)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#rpsfpy.rpsf.Structure">Structure</a></code>.<code><a href="#rpsfpy.rpsf.Structure.diagcoef">diagcoef</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Diagonalize coeficient matrices, returns eigen values and vectors.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.diagcoef', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.diagcoef" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">diagcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;svd&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalize coeficient matrices, returns eigen values and vectors.&quot;&quot;&quot;</span>
    <span class="c1">#with svd</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#with eigen vectors</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;eig&#39;</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.readfromfile">
    <p>def <span class="ident">readfromfile</span>(</p><p>self, filename)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.readfromfile', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.readfromfile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">readfromfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.save2file">
    <p>def <span class="ident">save2file</span>(</p><p>self, filename=&#39;dphings.dat&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Save Structure function in ASCII file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.save2file', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.save2file" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dphings.dat&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save Structure function in ASCII file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphings</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;NGS structure function not available&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.setngspos">
    <p>def <span class="ident">setngspos</span>(</p><p>self, ngspos)</p>
    </div>
    

    
  
    <div class="desc"><p>Set NGS coordinates</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.setngspos', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.setngspos" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">setngspos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngspos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set NGS coordinates&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ngspos</span> <span class="o">=</span> <span class="n">ngspos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="rpsfpy.rpsf.StructureNGS.setobjpos">
    <p>def <span class="ident">setobjpos</span>(</p><p>self, objpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Set Object coordinates</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-rpsfpy.rpsf.StructureNGS.setobjpos', this);">Show source &equiv;</a></p>
  <div id="source-rpsfpy.rpsf.StructureNGS.setobjpos" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">setobjpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set Object coordinates&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objectpos</span> <span class="o">=</span> <span class="n">objpos</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
